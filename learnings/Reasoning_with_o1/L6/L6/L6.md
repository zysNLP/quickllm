# Lesson 6: Metaprompting with o1

Optimizing to production is one of the biggest painpoints we've seen developers experience with working with LLMs - with so much guidance for prompt engineering, RAG and fine-tuning out there, figuring out which optimization you need to hill-climb on your evals can be a difficult problem to frame and solve.

Luckily, it appears to be one of the use cases that `o1` is capable at. In this session we'll focus on how to use `o1-mini` to work with a set of evals to optimize our prompt for the task and improve score on our evals.


<div style="background-color:#fff6ff; padding:13px; border-width:3px; border-color:#efe6ef; border-style:solid; border-radius:6px">
<p> 💻 &nbsp; <b>Access <code>requirements.txt</code> and <code>helper.py</code> files:</b> 1) click on the <em>"File"</em> option on the top menu of the notebook and then 2) click on <em>"Open"</em>.

<p> ⬇ &nbsp; <b>Download Notebooks:</b> 1) click on the <em>"File"</em> option on the top menu of the notebook and then 2) click on <em>"Download as"</em> and select <em>"Notebook (.ipynb)"</em>.</p>

<p> 📒 &nbsp; For more help, please see the <em>"Appendix – Tips, Help, and Download"</em> Lesson.</p>

</div>

<p style="background-color:#f7fff8; padding:15px; border-width:3px; border-color:#e0f0e0; border-style:solid; border-radius:6px"> 🚨
&nbsp; <b>Different Run Results:</b> The output generated by AI models can vary with each execution due to their dynamic, probabilistic nature. Don't be surprised if your results differ from those shown in the video.</p>


```python
# Warning control
import warnings
warnings.filterwarnings('ignore')

# Import OpenAI key
from helper import get_openai_api_key
openai_api_key = get_openai_api_key()
```


```python
from openai import OpenAI
from IPython.display import display, Markdown
import pandas as pd
from concurrent.futures import ThreadPoolExecutor
from functionDefinitions import TOOLS
import csv
import json
import os
import matplotlib.pyplot as plt

GPT_MODEL = 'gpt-4o-mini'
O1_MODEL = 'o1'

client = OpenAI(api_key=openai_api_key)

pd.set_option('display.max_colwidth', None)
pd.set_option('display.max_rows', None)
pd.set_option('display.max_columns', None)

```


```python
from redlines import Redlines
from IPython.display import display, Markdown

def compare_strings(string1, string2):
    # Create a Redlines object to compare the strings
    diff = Redlines(string1, string2)
    
    # Display the differences using Markdown
    display(Markdown(diff.output_markdown))

# Example usage
string_a = "This is the original text for comparison purposes."
string_b = "This is the modified text to compare for differences."

compare_strings(string_a, string_b)
```


This is the <span style='color:red;font-weight:700;text-decoration:line-through;'>original </span><span style='color:green;font-weight:700;'>modified </span>text <span style='color:green;font-weight:700;'>to compare </span>for <span style='color:red;font-weight:700;text-decoration:line-through;'>comparison purposes.</span><span style='color:green;font-weight:700;'>differences.</span>


## Step 1: Generate 4o routine (prompt)

1. **主题**: 航班取消和变更政策的实施与优化。
2. **步骤**:
   - **第一步**: 生成一个4o例行程序（提示）。
     - 读取“航班取消和变更政策”的人工政策。
     - 生成一个4o例行程序来实施该政策并提供一些function tools给o1。
   - **第二步**: 评估。
     - 开发评估4o实施政策的方法。
   - **第三步**: 改进4o例行程序。
   - 迭代N次：
     - 评估->评分。
     - 提供初始人工政策、当前4o例行程序和评估结果给o1。
     - o1根据评估结果改进4o例行程序，解决评估中发现的问题。

我们将采用已创建的航班取消政策，并通过以下提示将其转换为基于LLM（大型语言模型）的例行程序。

这个过程也是O1的一个很好的应用，使用纯文本文档来创建指令和工具，供LLM使用。要深入了解此主题，请查看 [this cookbook](https://cookbook.openai.com/examples/o1/using_reasoning_for_routine_generation).

### 1.Policy背景解读

大多数内部知识库文章结构复杂，旨在供人类解读。它们通常包括复杂的图表、多步骤流程和决策树，这些对基于LLM的解决方案进行有意义的推理构成了挑战。通过将这些文档分解为例行程序，每条指令都可以简化并格式化为一种引导LLM通过一系列小而可管理的任务的指南。这种细粒度方法减少了歧义，使LLM能够有系统地处理信息，降低幻觉或偏离预期路径的风险。

将这些知识库文章转换为常规程序可能耗时且具有挑战性，尤其是对于试图构建自动化管道的公司。每个常规程序都必须考虑各种用户场景，其中需要明确定义操作。例如，当需要函数调用时，程序必须指定确切的信息检索或执行的操作——无论是触发API、检索外部数据还是引入额外的上下文。虽然使用传统的GPT类模型自动化此过程可以显著减少所需的手动工作量，但它通常会引入新的挑战。一些挑战包括设计足够具体且稳健的指令，以便LLM能够持续遵循，捕捉在客户互动中可能出现的独特边缘情况，提供高质量的少样本示例以指导模型的行为，以及在某些情况下，微调模型以实现更可靠或更专业的结果。

o1已经展示了高效解构这些文章并将其转换为一系列零样本例程的能力，这意味着LLM可以在没有大量示例或对类似任务的先前训练的情况下理解和遵循指令。这最大限度地减少了所需的提示努力，因为例程结构本身为LLM完成每个步骤提供了必要的指导。通过将任务分解为具体动作并在需要时整合函数调用，o1的方法确保LLM可以无缝地处理复杂的流程，从而带来更有效和可扩展的客户服务解决方案。


```python
with open('originalPolicy/flightCancellationsPolicy.md', 'r') as file:
    flight_cancellation_policy = file.read()
    print(flight_cancellation_policy)
```



### 2.现有的policy的问题

所有细节分散在整个文档的各处，模型不得不深度跳跃理解，因此准备使用o1优化

    # **Internal Flight Cancellations and Changes Policy**
    
    **Purpose**: This document serves as a detailed guide for internal support agents to handle flight cancellations and changes. The focus is on providing clear instructions, ensuring efficiency, consistency, and customer satisfaction during calls.
    
    **Note**: Always maintain a calm, empathetic tone while assisting customers, especially during stressful situations involving cancellations or major changes.
    
    ## **Table of Contents**
    
    1. General Guidelines for Handling Customer Requests  
    2. Cancellations: Types and Policies  
    3. Changes: Types and Policies  
    4. Rebooking Guidelines  
    5. Compensation and Refund Rules  
    6. Special Cases  
    7. FAQs for Common Scenarios
    
    ### **1\. General Guidelines for Handling Customer Requests**
    
    * **Confirm Identity**: Verify the customer's identity by asking for their booking reference and any additional required details (e.g., name and flight number).  
    * **Listen and Understand**: Clarify if the customer is looking to cancel, change, or inquire about compensation.  
    * **Check the Ticket Type**: Determine if the ticket is non-refundable, refundable, or flexible. This will affect the available options.  
    * **Be Empathetic**: Express empathy, especially when the customer is dealing with a disruption caused by the airline.
    * **Rely on Internal Data**: Only collect personal data from users (e.g. name, medical data, age, booking reference). All data regarding flights (such as fare type or refund amount) should be confirmed internally. 
    
    ### **2\. Cancellations: Types and Policies**
    
    #### **2.1 Customer-Initiated Cancellations**
    
    * **Refundable Tickets**: Eligible for a full or partial refund based on cancellation timing.  
      * **Within 24 hours of booking**: Full refund guaranteed.  
      * **Beyond 24 hours**: Check the specific fare rules for applicable refund amounts.  
    * **Non-Refundable Tickets**:  
      * **Flight Credit**: Offer flight credit for future use, subject to an administration fee.  
      * **Penalty Fee**: Advise customers of any penalty fee applicable.
    
    #### **2.2 Airline-Initiated Cancellations**
    
    * **Weather-Related Cancellations**:  
      * **Rebook Without Fees**: Allow the customer to rebook on the next available flight without any additional charges.  
      * **Refund Options**: If the rebooking option is not acceptable, offer a full refund.  
    * **Mechanical Issues/Operational Changes**:  
      * **Rebooking Priority**: Give affected customers priority for rebooking.  
      * **Accommodation**: Offer hotel accommodation if the delay requires an overnight stay (for cancellations within 6 hours of departure).
    
    #### **2.3 No-Show Policy**
    
    * **No Refund for Non-Refundable Tickets**: No refunds are issued for no-shows; however, travel credits may be applied in certain cases.  
    * **Partial Refund for Refundable Tickets**: Refund any taxes or airport fees where applicable.
    
    ### **3\. Changes: Types and Policies**
    
    #### **3.1 Customer-Initiated Changes**
    
    * **Same-Day Changes**:  
      * **Flexible Tickets**: Allow changes without any fees, subject to availability.  
      * **Non-Flexible Tickets**: Charge a change fee. The customer must also pay any fare difference.  
    * **Changes in Advance**:  
      * **Within 7 Days of Departure**: Standard change fee applies.  
      * **Beyond 7 Days**: Lesser fee or free changes based on ticket type.
    
    #### **3.2 Airline-Initiated Changes**
    
    * **Schedule Changes**:  
      * **Minor Changes (Less than 2 Hours)**: Inform the customer of the new schedule and offer an alternative only upon request.  
      * **Major Changes (2+ Hours)**: Provide options to rebook, receive a full refund, or travel credit.
    
    ### **4\. Rebooking Guidelines**
    
    * **Priority Handling**: Rebook the customer on the next available flight operated by our airline first.  
    * **Interline Agreements**: If no suitable options are available, check our interline partners to facilitate alternative connections.  
    * **Upgrade Availability**: Offer a complimentary upgrade when an available flight is in a higher class but no economy seat is free.
    
    ### **5\. Compensation and Refund Rules**
    
    #### **5.1 Refund Processing**
    
    * **Refund Timeline**: Inform the customer that refunds will be processed within 7-10 business days for credit card payments and 14-20 business days for debit card payments.  
    * **Refund Options**:  
      * **Original Payment Method**: Refunds will generally be credited back to the original method of payment.  
      * **Travel Credits**: Offer travel credits as an alternative, with a bonus percentage (e.g., 10%) as an incentive.
    
    #### **5.2 Compensation**
    
    * **EU/US Compensation Rules**: Depending on the region, inform customers of their right to compensation based on the length of delay and cause.  
      * **Meals and Accommodation**: If the delay exceeds four hours, provide meal vouchers or hotel accommodation.
    
    ### **6\. Special Cases**
    
    #### **6.1 Medical Emergencies**
    
    * **Flexible Cancellations**: Allow for full cancellation or flight credit when a medical certificate ID is provided.  
    * **Flight Changes**: Waive change fees if the customer or immediate family member is ill.
    
    #### **6.2 Bereavement Cases**
    
    * **Special Flexibility**: Offer flexibility on cancellations or changes for bereavement. Request proper documentation if needed.
    
    #### **6.3 Group Bookings**
    
    * **Partial Cancellations**: Allow individual cancellations within a group booking, but advise that this may affect the group rate.  
    * **Name Changes**: Permit one name change per passenger at no additional cost if made 7+ days before departure.
    
    #### **6.4 Unaccompanied Minors**
    
    * **Rebooking with Supervision**: Ensure proper supervision is arranged if changes are needed to flights involving unaccompanied minors.  
    * **Priority for Minors**: Always prioritize getting unaccompanied minors on the next available flight.
    
    ### **7\. FAQs for Common Scenarios**
    
    **Q1: What if a customer’s connecting flight is affected?**
    
    * **Policy**: Always prioritize rebooking for missed connections caused by airline delays. Ensure the customer is protected for onward flights without additional fees.
    
    **Q2: How do I handle customers seeking upgrades after a cancellation?**
    
    * **Policy**: Offer upgrades based on availability if the original fare class is sold out. Otherwise, advise on the fare difference.
    
    **Q3: What if a customer needs to change a destination?**
    
    * **Policy**: Allow changes to a different destination, but advise the customer of any applicable fare differences and change fees.
    
    **Q4: What are the rules around rebooking for third-party bookings?**
    
    * **Policy**: Request that the customer contacts the original booking agent (e.g., travel agency, online booking platform) to make changes. Provide assistance if the booking is eligible for direct airline handling.
    
    **Q5: What should I do if the customer requests compensation for inconvenience?**
    
    * **Policy**: Assess eligibility based on the airline's compensation policy. Inform the customer about meal vouchers, accommodation, or monetary compensation if applicable.
    
    **Q6: How do I handle a situation where a customer’s preferred flight is fully booked?**
    
    * **Policy**: Offer the customer the next available option and place them on a waitlist for their preferred flight if possible. Consider offering an upgrade to a higher class if available.

```python
# **内部航班取消和变更政策**

**目的**：本文档为内部支持人员提供详细指南，以处理航班取消和变更。重点在于提供清晰的指示，确保在通话过程中高效、一致并让客户满意。

**注意**：在协助客户时，尤其是在涉及取消或重大变更的压力情况下，始终保持冷静、同理心的语气。

## **目录**

1. 处理客户请求的一般指南  
2. 取消：类型和政策  
3. 变更：类型和政策  
4. 重新预订指南  
5. 补偿和退款规则  
6. 特殊情况  
7. 常见场景的常见问题解答

### **1\. 处理客户请求的一般指南**

* **确认身份**：通过询问客户的预订参考号和任何其他所需详细信息（例如姓名和航班号）来验证客户身份。  
* **倾听和理解**：明确客户是希望取消、变更还是询问补偿。  
* **检查票务类型**：确定机票是否不可退款、可退款或灵活。这将影响可用选项。  
* **表达同理心**：特别是在客户因航空公司造成的中断而感到困扰时，表达同理心。  
* **依赖内部数据**：仅从用户处收集个人数据（例如姓名、医疗数据、年龄、预订参考号）。所有关于航班的数据（如票价类型或退款金额）应在内部确认。

### **2\. 取消：类型和政策**

#### **2.1 客户发起的取消**

* **可退款机票**：根据取消时间，有资格获得全额或部分退款。  
  * **预订后24小时内**：保证全额退款。  
  * **超过24小时**：检查具体票价规则以确定适用的退款金额。  
* **不可退款机票**：  
  * **航班积分**：提供未来使用的航班积分，需支付管理费。  
  * **罚金**：告知客户适用的任何罚金。

#### **2.2 航空公司发起的取消**

* **天气相关取消**：  
  * **免费重新预订**：允许客户在下一可用航班上重新预订，无需额外费用。  
  * **退款选项**：如果重新预订不可接受，提供全额退款。  
* **机械问题/运营变更**：  
  * **重新预订优先权**：为受影响的客户提供重新预订的优先权。  
  * **住宿**：如果延误需要过夜，提供酒店住宿（适用于起飞前6小时内的取消）。

#### **2.3 未出现政策**

* **不可退款机票无退款**：未出现情况下不退款；但在某些情况下可应用旅行积分。  
* **可退款机票的部分退款**：在适用的情况下退还任何税费或机场费用。

### **3\. 变更：类型和政策**

#### **3.1 客户发起的变更**

* **当天变更**：  
  * **灵活机票**：允许免费变更，视供应情况而定。  
  * **非灵活机票**：收取变更费。客户还需支付任何票价差额。  
* **提前变更**：  
  * **出发前7天内**：适用标准变更费。  
  * **超过7天**：根据票务类型，收取较少费用或免费变更。

#### **3.2 航空公司发起的变更**

* **航班时刻变更**：  
  * **小变更（少于2小时）**：通知客户新的航班时刻，仅在客户要求时提供替代方案。  
  * **大变更（2小时以上）**：提供重新预订、全额退款或旅行积分的选项。

### **4\. 重新预订指南**

* **优先处理**：首先将客户重新预订到我们航空公司的下一可用航班。  
* **跨行协议**：如果没有合适的选项，检查我们的跨行合作伙伴以促进替代连接。  
* **升级可用性**：当可用航班为更高舱位但经济舱座位已满时，提供免费升级。

### **5\. 补偿和退款规则**

#### **5.1 退款处理**

* **退款时间表**：告知客户，信用卡支付的退款将在7-10个工作日内处理，借记卡支付的退款将在14-20个工作日内处理。  
* **退款选项**：  
  * **原支付方式**：退款通常会退回到原支付方式。  
  * **旅行积分**：提供旅行积分作为替代方案，并给予额外百分比（例如10%）作为激励。

#### **5.2 补偿**

* **欧盟/美国补偿规则**：根据地区，告知客户基于延误时间和原因的补偿权利。  
  * **餐饮和住宿**：如果延误超过四小时，提供餐饮券或酒店住宿。

### **6\. 特殊情况**

#### **6.1 医疗紧急情况**

* **灵活取消**：在提供医疗证明的情况下，允许全额取消或提供航班积分。  
* **航班变更**：如果客户或直系亲属生病，免除变更费。

#### **6.2 丧亲情况**

* **特殊灵活性**：为丧亲情况提供取消或变更的灵活性。如果需要，请求适当的文件。

#### **6.3 团体预订**

* **部分取消**：允许团体预订中的个人取消，但告知这可能会影响团体费率。  
* **姓名变更**：允许每位乘客在出发前7天以上进行一次免费姓名变更。

#### **6.4 无人陪伴的未成年人**

* **有监督的重新预订**：如果需要对涉及无人陪伴的未成年人的航班进行变更，确保安排适当的监督。  
* **未成年人优先**：始终优先让无人陪伴的未成年人登上下一可用航班。

### **7\. 常见场景的常见问题解答**

**Q1：如果客户的转机航班受到影响怎么办？**

* **政策**：始终优先为因航空公司延误而错过的转机航班重新预订。确保客户在继续航班时无需支付额外费用。

**Q2：如何处理客户在取消后寻求升级的情况？**

* **政策**：如果原票价舱位已售罄，根据可用性提供升级。否则，告知票价差额。

**Q3：如果客户需要更改目的地怎么办？**

* **政策**：允许更改到不同的目的地，但告知客户任何适用的票价差额和变更费。

**Q4：第三方预订的重新预订规则是什么？**

* **政策**：要求客户联系原始预订代理（例如旅行社、在线预订平台）进行变更。如果预订符合航空公司直接处理的条件，则提供协助。

**Q5：如果客户要求补偿不便之处，我该怎么办？**

* **政策**：根据航空公司的补偿政策评估资格。如果适用，告知客户有关餐饮券、住宿或货币补偿的信息。

**Q6：如果客户的首选航班已满，我该如何处理？**

* **政策**：为客户提供下一个可用选项，并在可能的情况下将其列入首选航班的候补名单。如果可用，考虑提供更高舱位的升级。
```

### 3.o1转换复杂policy的prompt

```python
CONVERSION_PROMPT = f"""
你是一个有用的助手，任务是将一个对外帮助中心文章转换为内部面向的可编程执行的例行程序，并优化用于LLM（大型语言模型）。使用此例行程序的LLM将负责阅读政策、回答客户的提问，并帮助推动案件解决。

请遵循以下指示：
1. **仔细审查客户服务政策**，确保每个步骤都得到考虑。跳过任何步骤或政策是至关重要的。
2. **将指令组织成逻辑清晰的逐步顺序**，使用指定的格式。
3. **使用以下格式**：
   - **主要操作编号**（例如，1, 2, 3）。
   - **子操作在其相关的主要操作下用字母标记**（例如，1a, 1b）。
      **子操作应在新行开始**
   - **使用清晰的“如果...那么...否则”语句指定条件**（例如，“如果产品在30天内购买，那么...”）。
   - **对于需要从客户那里获取更多信息的指令**，提供礼貌且专业的提示以请求额外信息。
   - **对于需要从外部系统获取数据的操作**，编写一个步骤来调用函数，使用反引号表示函数名（例如，调用`check_delivery_date`函数）。
      - **如果某个步骤需要客户服务代理采取行动**（例如，处理退款），生成一个函数调用（例如，调用`process_refund`函数）。
      - **仅使用下面定义的可用函数集。
   - **如果助手可以代表用户执行某个操作**，包括一个函数调用（例如，调用`change_email_address`函数），并确保函数定义明确其目的和所需参数。
      - **仅使用下面定义的可用函数集。
   - **在案件解决之前的步骤应始终询问是否还有其他需要协助的地方**。
   - **以案件解决的最终操作结束**：调用`case_resolution`函数应始终是最后一步。
4. **确保合规**，确保所有步骤都遵守公司政策、隐私法规和法律要求。
5. **处理异常或升级**，为超出标准政策的情景指定步骤。
6. **确保覆盖**，检查政策中涵盖的所有条件也在例行程序中得到覆盖。

**重要提示**：始终将你返回的函数用反引号括起来，即`check_ticket_type`。不要包含函数的参数。

以下是当前可用的函数集，以JSON格式提供：
工具：{TOOLS}

请将以下客户服务政策转换为格式化的例行程序，确保其易于遵循和执行。确保**仅**使用提供的函数，**不要**创建新的函数。"""
```

```python
CONVERSION_PROMPT = f"""
You are a helpful assistant tasked with taking an external facing help center article and converting it into a internal-facing programmatically executable routine optimized for an LLM. 
The LLM using this routine will be tasked with reading the policy, answering incoming questions from customers, and helping drive the case toward resolution.

Please follow these instructions:
1. **Review the customer service policy carefully** to ensure every step is accounted for. It is crucial not to skip any steps or policies.
2. **Organize the instructions into a logical, step-by-step order**, using the specified format. 
3. **Use the following format**:
   - **Main actions are numbered** (e.g., 1, 2, 3).
   - **Sub-actions are lettered** under their relevant main actions (e.g., 1a, 1b).
      **Sub-actions should start on new lines**
   - **Specify conditions using clear 'if...then...else' statements** (e.g., 'If the product was purchased within 30 days, then...').
   - **For instructions that require more information from the customer**, provide polite and professional prompts to ask for additional information.
   - **For actions that require data from external systems**, write a step to call a function using backticks for the function name (e.g., call the `check_delivery_date` function).
      - **If a step requires the customer service agent to take an action** (e.g., process a refund), generate a function call for this action (e.g., call the `process_refund` function).
      - **Only use the available set of functions that are defined below.
   - **If there is an action an assistant can perform on behalf of the user**, include a function call for this action (e.g., call the `change_email_address` function), and ensure the function is defined with its purpose and required parameters.
      - **Only use the available set of functions that are defined below.
   - **The step prior to case resolution should always be to ask if there is anything more you can assist with**.
   - **End with a final action for case resolution**: calling the `case_resolution` function should always be the final step.
4. **Ensure compliance** by making sure all steps adhere to company policies, privacy regulations, and legal requirements.
5. **Handle exceptions or escalations** by specifying steps for scenarios that fall outside the standard policy.
6. **Ensure coverage** by checking that all of the conditions covered in the policy are also covered in the routines

**Important**: Always wrap the functions you return in backticks i.e. `check_ticket_type`. Do not include the arguments to the functions.

Here are the currently available set of functions in JSON format: 
TOOLS: {TOOLS}

Please convert the following customer service policy into the formatted routine, ensuring it is easy to follow and execute programmatically. Ensure that you **only** use the functions provided and do **not** create net new functions."""
```

### 4.执行转换prompt的函数 


```python
def generate_routine(policy):
    try:
        messages = [
            {
                "role": "user",
                "content": f"""
                    {CONVERSION_PROMPT}

                    POLICY:
                    {policy}
                """
            }
        ]

        response = client.chat.completions.create(
            model='o1-mini',
            messages=messages
        )
        

        return response.choices[0].message.content 
    except Exception as e:
        print(f"An error occurred: {e}")
```


```python
flight_cancellation_routine = generate_routine(flight_cancellation_policy)
```

### 5.o1生成的例行程序(baseline)


```python
display(Markdown(flight_cancellation_routine))
```

#### 5.1中文版

1. **验证客户身份**
   - a. 调用 `verify_identity` 函数。

2. **理解客户请求**
   - a. 调用 `ask_clarification` 函数，提示：“您是想取消、更改还是咨询航班补偿？”

3. **确定请求类型**
   - a. 如果客户想**取消**，则转到**处理取消**。
   - b. 如果客户想**更改**，则转到**处理更改**。
   - c. 如果客户想**咨询补偿**，则转到**处理补偿请求**。
   - d. 否则，调用 `ask_clarification` 函数，提示：“您能否提供更多关于您请求的详细信息？”

4. **处理取消**
   - a. 调用 `check_ticket_type` 函数。
   - b. 如果机票类型为**可退款**，则：
     - i. 如果取消是在**预订后24小时内**，调用 `process_full_refund` 函数。
     - ii. 否则，调用 `check_fare_rules` 函数。
       - 如果符合**部分退款**条件，调用 `process_partial_refund` 函数。
       - 否则，调用 `process_full_refund` 函数。
   - c. 如果机票类型为**不可退款**，则：
     - i. 调用 `offer_flight_credit` 函数。
     - ii. 告知客户任何适用的罚金。
   - d. 否则，升级该案例。

5. **处理航空公司发起的取消**
   - a. 确定取消原因。
   - b. 如果取消是**天气相关**，则：
     - i. 调用 `rebook_without_fee` 函数。
     - ii. 如果重新预订不可接受，调用 `process_full_refund` 函数。
   - c. 如果取消是由于**机械问题或运营变更**，则：
     - i. 调用 `prioritize_missed_connections` 函数。
     - ii. 如果需要过夜住宿，调用 `offer_accommodation` 函数。
   - d. 否则，升级该案例。

6. **处理未登机政策**
   - a. 调用 `check_ticket_type` 函数。
   - b. 如果机票类型为**不可退款**，则：
     - i. 调用 `offer_flight_credit` 函数。
   - c. 如果机票类型为**可退款**，则：
     - i. 调用 `process_partial_refund` 函数，退还适用的税费。
   - d. 否则，升级该案例。

7. **处理更改**
   - a. 调用 `check_ticket_type` 函数。
   - b. 如果更改是**当天**，则：
     - i. 如果机票类型为**灵活**，调用 `process_change_no_fee` 函数。
     - ii. 如果机票类型为**不灵活**，调用 `apply_change_fee` 函数，并告知客户任何票价差异。
   - c. 如果更改是**提前**，则：
     - i. 如果更改在**起飞前7天内**，调用 `apply_change_fee` 函数。
     - ii. 如果更改在**7天以外**，根据机票类型调用 `apply_lesser_change_fee` 函数。
   - d. 否则，升级该案例。

8. **处理航空公司发起的更改**
   - a. 确定航班变更的程度。
   - b. 如果变更是**轻微（少于2小时）**，告知客户并根据请求提供替代方案。
   - c. 如果变更是**重大（2小时以上）**，则：
     - i. 调用 `rebook_without_fee` 函数。
     - ii. 如果重新预订不可接受，调用 `process_full_refund` 函数。
     - iii. 调用 `offer_flight_credit` 函数作为替代方案。
   - d. 否则，升级该案例。

9. **重新预订指南**
   - a. 调用 `check_next_available_flight` 函数。
   - b. 如果有可用航班，调用 `book_flight` 函数。
   - c. 如果没有合适的选项，调用 `check_interline_partners` 函数。
     - i. 如果有联营伙伴航班可用，调用 `book_interline_flight` 函数。
     - ii. 否则，告知客户并提供航班积分，调用 `offer_flight_credit` 函数。
   - d. 如果有更高舱位可用，调用 `offer_available_upgrades` 函数。
   - e. 如果适用，为无人陪伴的未成年人调用 `prioritize_minors_rebooking` 函数。

10. **补偿和退款处理**
    - a. 调用 `determine_refund_method` 函数。
    - b. 如果退款到**原支付方式**，调用 `process_refund` 函数。
    - c. 如果提供**旅行积分**，调用 `apply_travel_credit` 函数，并附加额外百分比。
    - d. 对于补偿咨询，调用 `check_compensation_eligibility` 函数。
      - i. 如果符合条件，提供餐券或住宿，调用 `offer_accommodation` 函数。
    - e. 根据支付方式告知客户退款时间。

11. **处理特殊情况**
    - a. 如果案例是**医疗紧急情况**，则：
      - i. 调用 `process_flexible_cancellation` 函数，并提供医疗证明。
      - ii. 如果请求航班更改，调用 `waive_change_fees` 函数，并提供相关文件。
    - b. 如果案例是**丧亲**，则：
      - i. 调用 `apply_bereavement_flexibility` 函数，并提供必要文件。
    - c. 如果处理**团体预订**，则：
      - i. 如果请求个别取消，调用 `process_partial_group_cancellation` 函数。
      - ii. 如果请求更改姓名，调用 `permit_name_change` 函数。
    - d. 如果处理**无人陪伴的未成年人**，则：
      - i. 调用 `arrange_supervision` 函数。
      - ii. 调用 `prioritize_minors_rebooking` 函数。
    - e. 否则，升级该案例。

12. **处理常见问题的FAQ**
    - a. 如果客户询问**转机航班是否受影响**，调用 `prioritize_missed_connections` 函数。
    - b. 如果客户在取消后寻求**升级**，调用 `offer_available_upgrades` 函数。
    - c. 如果客户需要**更改目的地**，调用 `process_destination_change` 函数。
    - d. 如果预订是**第三方预订**，调用 `assist_third_party_booking` 函数。
    - e. 如果客户请求**不便补偿**，调用 `assess_compensation_request` 函数。
    - f. 如果客户的**首选航班已满**，提供下一个可用选项并将其加入候补名单，调用 `provide_alternative_options` 函数。
    - g. 否则，升级该案例。

13. **确认额外协助**
    - a. 询问客户：“还有什么我可以帮您的吗？”

14. **解决案例**
    - a. 调用 `case_resolution` 函数。

#### 5.2英文版


1. **Verify Customer Identity**
   - a. Call the `verify_identity` function.

2. **Understand Customer Request**
   - a. Call the `ask_clarification` function with prompt: "Are you looking to cancel, change, or inquire about compensation for your flight?"

3. **Determine Request Type**
   - a. If the customer wants to **cancel**, then proceed to **Handle Cancellations**.
   - b. If the customer wants to **change**, then proceed to **Handle Changes**.
   - c. If the customer wants to **inquire about compensation**, then proceed to **Handle Compensation Requests**.
   - d. Else, call the `ask_clarification` function with prompt: "Could you please provide more details about your request?"

4. **Handle Cancellations**
   - a. Call the `check_ticket_type` function.
   - b. If ticket type is **refundable**, then:
      - i. If cancellation is **within 24 hours of booking**, call the `process_full_refund` function.
      - ii. Else, call the `check_fare_rules` function.
         - If eligible for **partial refund**, call the `process_partial_refund` function.
         - Else, call the `process_full_refund` function.
   - c. Else if ticket type is **non-refundable**, then:
      - i. Call the `offer_flight_credit` function.
      - ii. Inform the customer about any applicable penalty fees.
   - d. Else, escalate the case.

5. **Handle Airline-Initiated Cancellations**
   - a. Determine the reason for cancellation.
   - b. If cancellation is **weather-related**, then:
      - i. Call the `rebook_without_fee` function.
      - ii. If rebooking is not acceptable, call the `process_full_refund` function.
   - c. If cancellation is due to **mechanical issues or operational changes**, then:
      - i. Call the `prioritize_missed_connections` function.
      - ii. If an overnight stay is required, call the `offer_accommodation` function.
   - d. Else, escalate the case.

6. **Handle No-Show Policy**
   - a. Call the `check_ticket_type` function.
   - b. If ticket type is **non-refundable**, then:
      - i. Call the `offer_flight_credit` function.
   - c. If ticket type is **refundable**, then:
      - i. Call the `process_partial_refund` function for applicable taxes or fees.
   - d. Else, escalate the case.

7. **Handle Changes**
   - a. Call the `check_ticket_type` function.
   - b. If change is **same-day**, then:
      - i. If ticket type is **flexible**, call the `process_change_no_fee` function.
      - ii. If ticket type is **non-flexible**, call the `apply_change_fee` function and inform the customer about any fare differences.
   - c. If change is **in advance**, then:
      - i. If change is **within 7 days of departure**, call the `apply_change_fee` function.
      - ii. If change is **beyond 7 days**, call the `apply_lesser_change_fee` function based on ticket type.
   - d. Else, escalate the case.

8. **Handle Airline-Initiated Changes**
   - a. Determine the extent of schedule changes.
   - b. If changes are **minor (less than 2 hours)**, inform the customer and offer alternatives upon request.
   - c. If changes are **major (2+ hours)**, then:
      - i. Call the `rebook_without_fee` function.
      - ii. Call the `process_full_refund` function if rebooking is not acceptable.
      - iii. Call the `offer_flight_credit` function as an alternative.
   - d. Else, escalate the case.

9. **Rebooking Guidelines**
   - a. Call the `check_next_available_flight` function.
   - b. If an available flight is found, call the `book_flight` function.
   - c. If no suitable options are available, call the `check_interline_partners` function.
      - i. If an interline partner flight is available, call the `book_interline_flight` function.
      - ii. Else, inform the customer and offer flight credit by calling the `offer_flight_credit` function.
   - d. Call the `offer_available_upgrades` function if a higher class is available.
   - e. If applicable, call the `prioritize_minors_rebooking` function for unaccompanied minors.

10. **Compensation and Refund Processing**
    - a. Call the `determine_refund_method` function.
    - b. If refund is to the **original payment method**, call the `process_refund` function.
    - c. If offering **travel credits**, call the `apply_travel_credit` function with a bonus percentage.
    - d. For compensation inquiries, call the `check_compensation_eligibility` function.
       - i. If eligible, provide meal vouchers or accommodation by calling the `offer_accommodation` function.
    - e. Inform the customer about the refund timeline based on payment method.

11. **Handle Special Cases**
    - a. If the case is a **medical emergency**, then:
       - i. Call the `process_flexible_cancellation` function with the medical certificate.
       - ii. If requesting flight changes, call the `waive_change_fees` function with relevant documentation.
    - b. If the case is for **bereavement**, then:
       - i. Call the `apply_bereavement_flexibility` function with necessary documentation.
    - c. If handling a **group booking**, then:
       - i. If individual cancellations are requested, call the `process_partial_group_cancellation` function.
       - ii. If name changes are requested, call the `permit_name_change` function.
    - d. If dealing with **unaccompanied minors**, then:
       - i. Call the `arrange_supervision` function.
       - ii. Call the `prioritize_minors_rebooking` function.
    - e. Else, escalate the case.

12. **Handle FAQs for Common Scenarios**
    - a. If the customer asks about **connecting flights being affected**, call the `prioritize_missed_connections` function.
    - b. If the customer seeks **upgrades after a cancellation**, call the `offer_available_upgrades` function.
    - c. If the customer needs to **change a destination**, call the `process_destination_change` function.
    - d. If the booking is a **third-party booking**, call the `assist_third_party_booking` function.
    - e. If the customer requests **compensation for inconvenience**, call the `assess_compensation_request` function.
    - f. If the customer’s **preferred flight is fully booked**, offer the next available option and place them on a waitlist by calling the `provide_alternative_options` function.
    - g. Else, escalate the case.

13. **Confirm Additional Assistance**
    - a. Ask the customer: "Is there anything else I can assist you with?"

14. **Resolve Case**
    - a. Call the `case_resolution` function.


### Data quality check

We'll check that `o1-mini` has followed our instructions and used only the functions we provided.

If it added additional ones, we'll need to write functions for them before proceeding.

这段代码用于进行数据质量检查，确保 `o1-mini` 模型在生成例行程序时仅使用了提供的函数，而没有添加额外的函数。具体步骤如下：

1. **比较列表**：`compare_lists` 函数比较两个列表，找出在一个列表中存在但在另一个列表中不存在的元素，或者在一个列表中数量更多的元素。

2. **提取函数名**：`extract_function_names` 函数使用正则表达式从生成的例行程序中提取所有被反引号括起来的函数名。

3. **提取已定义的函数名**：从提供的 `TOOLS` 列表中提取所有已定义的函数名。

4. **比较生成的函数名和已定义的函数名**：使用 `compare_lists` 函数比较从生成的例行程序中提取的函数名和已定义的函数名，找出差异。

5. **输出差异**：
   - **在生成的例行程序中但未在已定义函数列表中的函数**：这些是需要为其编写新函数的。
   - **在已定义函数列表中但未在生成的例行程序中的函数**：这些是未在生成的例行程序中使用的函数，无需处理。

在这个例子中，输出显示没有差异，意味着生成的例行程序仅使用了提供的函数，没有添加额外的函数。


```python
import re
from collections import Counter

def compare_lists(a, b):
    # Create Counters for both lists
    counter_a = Counter(a)
    counter_b = Counter(b)
    
    # Find elements that are only in A or have a higher count in A
    diff_a = counter_a - counter_b
    # Find elements that are only in B or have a higher count in B
    diff_b = counter_b - counter_a
    
    # Report differences
    print("Items in A that are not in B (or more of in A):")
    for item, count in diff_a.items():
        print(f"{item}: {count}")

    print("\nItems in B that are not in A (or more of in B):")
    for item, count in diff_b.items():
        print(f"{item}: {count}")

def extract_function_names(text):
    # Use regex to match text between backticks and extract function names
    pattern = r'`(.*?)`'
    matches = re.findall(pattern, text)
    return matches

# Extract a unique list of the functions in the generated routine
function_names_from_o1 = set(extract_function_names(flight_cancellation_routine))

# Extract the list of TOOLs we provided the model
function_names_defined = [tool["function"]["name"] for tool in TOOLS if tool["type"] == "function"]

# Print the differences
## Items that are in A and not in B need functions written for them
## Items that are in B and not in A are fine, they are just unused in the routine the model has written
compare_lists(function_names_from_o1, function_names_defined)
```

    Items in A that are not in B (or more of in A):
    
    Items in B that are not in A (or more of in B):


## Step 2: Evaluation

现在我们有了一个由 `o1` 生成的例行程序，我们可以将其与我们的评估套件进行对比，并测量其准确性。

我们将首先创建一个配备了政策和工具列表的代理。该代理将接收来自现有对话的消息，并负责确定下一步应采取的最佳行动。

现在有多轮客户的请求，客户的信息和预期的回复函数，检查这个agent的质量依赖两方面：1.是否正确使用了预期的回复函数；2.该函数传参是否正确

![png](evaluates.png)


```python
def agent_response(transcript, policy, model):
    try:
        messages = [
            {
                "role": "system",
                "content": f"""
You are a customer service agent that is responsible for handling airline related issues. Below is the exact policy that you must follow to address the customer's issue.

POLICY:
{policy}
                """
            }
        ]

        messages.extend(transcript)
        response = client.chat.completions.create(
            model=model,
            messages=messages,
            tools=TOOLS,
            parallel_tool_calls=False,
        temperature=0)
        
        return response.choices[0].message 
    except Exception as e:
        print(f"An error occurred: {e}")
        print(messages)
```

We will process each row in parallel to reduce runtime and compare the function call + inputs that the model selects against our expected function + parameters.

我们将并行处理每一行以减少运行时间，并将模型选择的函数调用及其输入与预期的函数及参数进行比较。

```python
CUSTOMER_PROMPT = f"""<objective>你是一位名为{full_name}的客户，正在尝试与客户服务代理解决问题。
    继续提供代理请求的信息，以便他们能够解决你的问题。
    如果你的*details*中有相关信息，请使用这些信息。否则，请生成一个合适的回答。</objective>
    <details>
    预订参考号: {booking_ref}
    航班号: {flight_no}
    {f"医疗证明: {medical_certificate}" if medical_certificate else ""}
    背景: {context}
    你的初始请求: {request}
    </details>
    <guidance>
    记住，你是客户。
    如果代理需要某些信息，这些信息必须由你提供。
    不要向代理询问信息。
    </guidance>
    """
```


```python
import math 

def safe_str(value):
    return "" if (isinstance(value, float) and math.isnan(value)) else str(value)

def process_row(row_number,test_row,policy,model,iteration=0, verbose=False):
    # Extract variables from test_row
    context = test_row['context']
    request = test_row['request']
    full_name = test_row['full_name']
    booking_ref = test_row['booking_ref']
    flight_no = test_row['flight_no']
    ticket_type = test_row['ticket_type']
    fare_rules = safe_str(test_row['fare_rules'])
    medical_certificate = safe_str(test_row['medical_certificate'])
    refund_amount = safe_str(test_row['refund_amount'])
    expected_function = test_row['expected_function']
    expected_inputs_str = test_row['expected_inputs']
    expected_inputs = json.loads(expected_inputs_str)

    CUSTOMER_PROMPT = f"""<objective>You are a customer named {full_name} trying to resolve an issue with a customer service agent.
    Continue providing the information the agent requests so they can solve your issue.
    If you have the information in your *details* then use that. Otherwise, generate an appropriate answer.</objective>
    <details>
    Booking Reference: {booking_ref}
    Flight Number: {flight_no}
    {f"Medical Reference: {medical_certificate}" if medical_certificate else ""}
    Context: {context}
    Your initial request: {request}
    </details>
    <guidance>
    Remember that YOU are the customer.
    If the agent needs some information, that must come from you. 
    Do not ask the agent for information.
    </guidance>
    """

    # Initialize transcript
    transcript = [{"role": "user", "content": request}]
    if verbose:
        print(f'Starting request: {request}')
    
    # Initialize variables
    is_correct = False

    loop_count = 0
    while True:
        loop_count += 1
        if loop_count > 10:
            actual_function = None
            actual_inputs = None
            break
        # Call agent_response with the current transcript, policy, model
        response = agent_response(transcript, policy, GPT_MODEL)
        
        # Extract assistant message content and tool_calls
        if response:
            assistant_message_content = response.content
            tool_calls = response.tool_calls
        else:
            assistant_message_content = None
            tool_calls = None
        
        if not tool_calls:
            # Append assistant's message to transcript
            transcript.append({"role": "assistant", "content": assistant_message_content})
            
            # Get customer response
            customer_messages = [{"role": "system", "content": CUSTOMER_PROMPT}]
            customer_messages.extend(transcript)
            
            customer_response = client.chat.completions.create(model=GPT_MODEL, messages=customer_messages)
            
            # Append customer response to transcript
            transcript.append({"role": "user", "content": customer_response.choices[0].message.content})
            
            # Continue the loop
            continue
        else:
            #print(tool_calls)
            # There is a tool call
            tool_call = tool_calls[0]  # Assuming we're only interested in the first tool call
            function_name = tool_call.function.name
            arguments = json.loads(tool_call.function.arguments)
            
            if function_name == 'verify_identity':
                # Append assistant's message to transcript
                transcript.append(response)
                
                # Simulate the tool response
                tool_response = "True"
                
                # Append the tool response to transcript
                transcript.append({"role": "tool", "content": tool_response, "tool_call_id": tool_call.id})
                
                # Continue the loop
                continue
            elif function_name == 'ask_clarification':
                # Take the 'prompt' from arguments and use it as assistant message
                clarification_prompt = arguments.get('prompt')
                
                # Append assistant's clarification message
                transcript.append({"role": "assistant", "content": clarification_prompt})
                
                # Get customer response
                customer_messages = [{"role": "system", "content": CUSTOMER_PROMPT}]
                customer_messages.extend(transcript)
                
                customer_response = client.chat.completions.create(model=GPT_MODEL, messages=customer_messages)
                
                # Append customer response to transcript
                transcript.append({"role": "user", "content": customer_response.choices[0].message.content})
                
                # Continue the loop
                continue
            elif function_name == 'check_ticket_type':
                # Append assistant's message to transcript
                transcript.append(response)
                
                tool_response = f'Ticket type: {ticket_type}\nFare rules: {fare_rules}'
                
                # Append the tool response to transcript
                transcript.append({"role": "tool", "content": tool_response, "tool_call_id": tool_call.id})
                
                # Continue the loop
                continue
            elif function_name == 'check_fare_rules':
                # Append assistant's message to transcript
                transcript.append(response)
                
                tool_response = f'Ticket type: {ticket_type}\nFare rules: {fare_rules}'

                if fare_rules == 'partial_refund':
                    tool_response += f'\nRefund amount: {refund_amount}'
                
                # Append the tool response to transcript
                transcript.append({"role": "tool", "content": tool_response, "tool_call_id": tool_call.id})
                
                # Continue the loop
                continue
            elif function_name == 'get_refund_amount':
                # Append assistant's message to transcript
                transcript.append(response)
                
                tool_response = f'Refund amount: {refund_amount}'
                
                # Append the tool response to transcript
                transcript.append({"role": "tool", "content": tool_response, "tool_call_id": tool_call.id})
                
                # Continue the loop
                continue
            elif function_name == 'check_next_available_flight':
                # Append assistant's message to transcript
                transcript.append(response)
                
                # simulating the tool response
                tool_response = f'Next available flight: LMG091 at 10:00 AM Tomorrow'
                
                # Append the tool response to transcript
                transcript.append({"role": "tool", "content": tool_response, "tool_call_id": tool_call.id})
                
                # Continue the loop
                continue
            elif function_name == 'provide_alternative_options':
                # Append assistant's message to transcript
                transcript.append(response)
                
                # simulating the tool response
                tool_response = f'Next available flight: FR9876 at 5:00 PM Tomorrow'
                
                # Append the tool response to transcript
                transcript.append({"role": "tool", "content": tool_response, "tool_call_id": tool_call.id})
                
                # Continue the loop
                continue
            else:
                if verbose:
                    print('Got a successful function call')
                # Stop and compare function call and arguments with expected_function and expected_inputs
                transcript.append(response)
                actual_function = function_name
                actual_inputs = arguments
                is_correct = (actual_function == expected_function) and (str(actual_inputs) == str(expected_inputs))
                
                # Break the loop
                break
    
    # Return the results
    return {
        'request': request,
        'context': context,
        'expected_function': expected_function,
        'expected_inputs': expected_inputs,
        'actual_function': actual_function,
        'actual_inputs': actual_inputs,
        'is_correct': is_correct,
        'transcript': transcript
    }

# added post-filming to address transcript size
def filter_messages(message_list):
    messages = []
    for item in message_list:
        # Convert the item to a string and check if 'ChatCompletionMessage' is in it.
        if 'ChatCompletionMessage' in str(item):
            #print(item)
            message = {"role": "assistant",
                       "tool_call": {
                           "name": item.tool_calls[0].function.name,
                           "arguments": item.tool_calls[0].function.arguments
                       }
                      }
            messages.append(message)
        else:
            messages.append(item)
    return messages


def evaluate_function_calls(df, policy, model, i=0, verbose=False):
    records = []

    # Use ThreadPoolExecutor to process rows in parallel
    with ThreadPoolExecutor() as executor:
        futures = {executor.submit(process_row, row_number, row, policy, model, i, verbose): row_number for row_number, row in df.iterrows()}
        for future in futures:
            record = future.result()
            records.append(record)


    df = pd.DataFrame(records)
    df['cleaned_transcript'] = df['transcript'].apply(filter_messages)
    total_accuracy = df['is_correct'].mean()
    return df, total_accuracy
```

Let's take a look at the results


```python
eval_df = pd.read_csv('evals/policyEvals.csv')
eval_df.head()
```


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>-</th>
      <th>ID</th>
      <th>context</th>
      <th>request</th>
      <th>full_name</th>
      <th>booking_ref</th>
      <th>flight_no</th>
      <th>expected_function</th>
      <th>expected_inputs</th>
      <th>ticket_type</th>
      <th>fare_rules</th>
      <th>medical_certificate</th>
      <th>refund_amount</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>I want to cancel my flight as I am initiating the cancellation myself.</td>
      <td>I would like to cancel my flight, please.</td>
      <td>John Doe</td>
      <td>ABC123</td>
      <td>XYZ789</td>
      <td>process_partial_refund</td>
      <td>{"booking_reference":"ABC123","refund_amount":198}</td>
      <td>refundable</td>
      <td>partial_refund</td>
      <td>NaN</td>
      <td>198.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>I want to change my flight to a different date.</td>
      <td>I'd like to initiate a change to my flight for a later date.</td>
      <td>Jane Smith</td>
      <td>DEF456</td>
      <td>XYZ123</td>
      <td>apply_change_fee</td>
      <td>{"booking_reference":"DEF456"}</td>
      <td>nonrefundable</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>I want to request a refund because my flight was canceled by the airline due to weather.</td>
      <td>My flight was canceled by the airline, and I want a refund.</td>
      <td>Emma Johnson</td>
      <td>GHI789</td>
      <td>ABC123</td>
      <td>process_full_refund</td>
      <td>{"booking_reference":"GHI789"}</td>
      <td>refundable</td>
      <td>full_refund</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>I want to cancel my flight but I think it is non-refundable.</td>
      <td>I want to cancel my non-refundable ticket.</td>
      <td>Michael Brown</td>
      <td>JKL012</td>
      <td>DEF456</td>
      <td>offer_flight_credit</td>
      <td>{"booking_reference":"JKL012"}</td>
      <td>nonrefundable</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>I want to cancel my flight and I believe it is refundable.</td>
      <td>I want to cancel my refundable ticket.</td>
      <td>Sarah Brown</td>
      <td>MNO345</td>
      <td>STU678</td>
      <td>process_partial_refund</td>
      <td>{"booking_reference":"MNO345","refund_amount":65}</td>
      <td>refundable</td>
      <td>partial_refund</td>
      <td>NaN</td>
      <td>65.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
from termcolor import colored

def display_row(index):
    eval_row = eval_df.iloc[index]
    df_row = df.iloc[index][["actual_function", "actual_inputs", "is_correct", "cleaned_transcript"]]
    transcript_list = df_row["cleaned_transcript"]

    print("Eval DataFrame Row:")
    print(eval_row)
    print("\nDataFrame Columns:")
    print("actual_function:", df_row["actual_function"])
    print("actual_inputs:", df_row["actual_inputs"])
    print("is_correct:", df_row["is_correct"])
    print("transcript:")
    for entry in transcript_list:
        role = entry["role"] if isinstance(entry, dict) else getattr(entry, "role", None)
        color = "blue" if role == "user" else "red"
        print(colored(str(entry), color))

```


```python
df, accuracy = evaluate_function_calls(eval_df, flight_cancellation_routine, GPT_MODEL)

# Display the accuracy as a mini header
display(Markdown(f"### Accuracy: {accuracy:.2%}"))

display(df)
```


### Accuracy: 52.94%



<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>-</th>
      <th>request</th>
      <th>context</th>
      <th>expected_function</th>
      <th>expected_inputs</th>
      <th>actual_function</th>
      <th>actual_inputs</th>
      <th>is_correct</th>
      <th>transcript</th>
      <th>cleaned_transcript</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>I would like to cancel my flight, please.</td>
      <td>I want to cancel my flight as I am initiating the cancellation myself.</td>
      <td>process_partial_refund</td>
      <td>{'booking_reference': 'ABC123', 'refund_amount': 198}</td>
      <td>process_partial_refund</td>
      <td>{'booking_reference': 'ABC123', 'refund_amount': 198}</td>
      <td>True</td>
      <td>[{'role': 'user', 'content': 'I would like to cancel my flight, please.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_piug1T4GeUY6wncpTJk0ZaFu', function=Function(arguments='{"booking_reference":"ABC123","full_name":"John Doe","flight_number":"XY123"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_piug1T4GeUY6wncpTJk0ZaFu'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to cancel my flight. My booking reference is ABC123, and the flight number is XYZ789.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_7ZSz1qkGHO7nWmNXPIegF9Tz', function=Function(arguments='{"booking_reference":"ABC123"}', name='check_ticket_type'), type='function')]), {'role': 'tool', 'content': 'Ticket type: refundable
Fare rules: partial_refund', 'tool_call_id': 'call_7ZSz1qkGHO7nWmNXPIegF9Tz'}, {'role': 'assistant', 'content': 'Since your ticket is refundable, I will check the cancellation details. 

Is your cancellation within 24 hours of booking?'}, {'role': 'user', 'content': 'No, my cancellation is not within 24 hours of booking.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_JVboYTTPsAhJcZfnlviGoSyI', function=Function(arguments='{"booking_reference":"ABC123"}', name='check_fare_rules'), type='function')]), {'role': 'tool', 'content': 'Ticket type: refundable
Fare rules: partial_refund
Refund amount: 198.0', 'tool_call_id': 'call_JVboYTTPsAhJcZfnlviGoSyI'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_wVIYzVLOsKqqHqxT896uLfKT', function=Function(arguments='{"booking_reference":"ABC123","refund_amount":198}', name='process_partial_refund'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'I would like to cancel my flight, please.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"ABC123","full_name":"John Doe","flight_number":"XY123"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_piug1T4GeUY6wncpTJk0ZaFu'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to cancel my flight. My booking reference is ABC123, and the flight number is XYZ789.'}, {'role': 'assistant', 'tool_call': {'name': 'check_ticket_type', 'arguments': '{"booking_reference":"ABC123"}'}}, {'role': 'tool', 'content': 'Ticket type: refundable
Fare rules: partial_refund', 'tool_call_id': 'call_7ZSz1qkGHO7nWmNXPIegF9Tz'}, {'role': 'assistant', 'content': 'Since your ticket is refundable, I will check the cancellation details. 

Is your cancellation within 24 hours of booking?'}, {'role': 'user', 'content': 'No, my cancellation is not within 24 hours of booking.'}, {'role': 'assistant', 'tool_call': {'name': 'check_fare_rules', 'arguments': '{"booking_reference":"ABC123"}'}}, {'role': 'tool', 'content': 'Ticket type: refundable
Fare rules: partial_refund
Refund amount: 198.0', 'tool_call_id': 'call_JVboYTTPsAhJcZfnlviGoSyI'}, {'role': 'assistant', 'tool_call': {'name': 'process_partial_refund', 'arguments': '{"booking_reference":"ABC123","refund_amount":198}'}}]</td>
    </tr>
    <tr>
      <th>1</th>
      <td>I'd like to initiate a change to my flight for a later date.</td>
      <td>I want to change my flight to a different date.</td>
      <td>apply_change_fee</td>
      <td>{'booking_reference': 'DEF456'}</td>
      <td>apply_change_fee</td>
      <td>{'booking_reference': 'DEF456'}</td>
      <td>True</td>
      <td>[{'role': 'user', 'content': 'I'd like to initiate a change to my flight for a later date.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_mgUKb3GjSZMVgaKeg5JSwDOI', function=Function(arguments='{"booking_reference":"ABC123","full_name":"John Doe","flight_number":"XY123"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_mgUKb3GjSZMVgaKeg5JSwDOI'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to change my flight to a later date. My booking reference is DEF456 and my flight number is XYZ123.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_JvgSWpMkSikvRT1U4boY32Wf', function=Function(arguments='{"booking_reference":"DEF456"}', name='check_ticket_type'), type='function')]), {'role': 'tool', 'content': 'Ticket type: nonrefundable
Fare rules: ', 'tool_call_id': 'call_JvgSWpMkSikvRT1U4boY32Wf'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_Fb8Qs2jAdInw2s3WAQEPkK6p', function=Function(arguments='{"booking_reference":"DEF456"}', name='apply_change_fee'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'I'd like to initiate a change to my flight for a later date.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"ABC123","full_name":"John Doe","flight_number":"XY123"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_mgUKb3GjSZMVgaKeg5JSwDOI'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to change my flight to a later date. My booking reference is DEF456 and my flight number is XYZ123.'}, {'role': 'assistant', 'tool_call': {'name': 'check_ticket_type', 'arguments': '{"booking_reference":"DEF456"}'}}, {'role': 'tool', 'content': 'Ticket type: nonrefundable
Fare rules: ', 'tool_call_id': 'call_JvgSWpMkSikvRT1U4boY32Wf'}, {'role': 'assistant', 'tool_call': {'name': 'apply_change_fee', 'arguments': '{"booking_reference":"DEF456"}'}}]</td>
    </tr>
    <tr>
      <th>2</th>
      <td>My flight was canceled by the airline, and I want a refund.</td>
      <td>I want to request a refund because my flight was canceled by the airline due to weather.</td>
      <td>process_full_refund</td>
      <td>{'booking_reference': 'GHI789'}</td>
      <td>process_full_refund</td>
      <td>{'booking_reference': 'GHI789'}</td>
      <td>True</td>
      <td>[{'role': 'user', 'content': 'My flight was canceled by the airline, and I want a refund.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_F0WHOGUVqn5ukrXBlENG1RGr', function=Function(arguments='{"booking_reference":"ABC123","full_name":"John Doe","flight_number":"XY123"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_F0WHOGUVqn5ukrXBlENG1RGr'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I am specifically looking for a refund for my canceled flight. The booking reference is GHI789 and the flight number is ABC123.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_4w7PfThyzepfErWxw5uWNhFB', function=Function(arguments='{"booking_reference":"GHI789"}', name='check_ticket_type'), type='function')]), {'role': 'tool', 'content': 'Ticket type: refundable
Fare rules: full_refund', 'tool_call_id': 'call_4w7PfThyzepfErWxw5uWNhFB'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_QtDgZZL3wCkHLiWZnzamLHKm', function=Function(arguments='{"booking_reference":"GHI789"}', name='process_full_refund'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'My flight was canceled by the airline, and I want a refund.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"ABC123","full_name":"John Doe","flight_number":"XY123"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_F0WHOGUVqn5ukrXBlENG1RGr'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I am specifically looking for a refund for my canceled flight. The booking reference is GHI789 and the flight number is ABC123.'}, {'role': 'assistant', 'tool_call': {'name': 'check_ticket_type', 'arguments': '{"booking_reference":"GHI789"}'}}, {'role': 'tool', 'content': 'Ticket type: refundable
Fare rules: full_refund', 'tool_call_id': 'call_4w7PfThyzepfErWxw5uWNhFB'}, {'role': 'assistant', 'tool_call': {'name': 'process_full_refund', 'arguments': '{"booking_reference":"GHI789"}'}}]</td>
    </tr>
    <tr>
      <th>3</th>
      <td>I want to cancel my non-refundable ticket.</td>
      <td>I want to cancel my flight but I think it is non-refundable.</td>
      <td>offer_flight_credit</td>
      <td>{'booking_reference': 'JKL012'}</td>
      <td>offer_flight_credit</td>
      <td>{'booking_reference': 'JKL012'}</td>
      <td>True</td>
      <td>[{'role': 'user', 'content': 'I want to cancel my non-refundable ticket.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_2KR4YsRFVlkY5JqMSVejyR1p', function=Function(arguments='{"booking_reference":"ABC123","full_name":"John Doe","flight_number":"XY123"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_2KR4YsRFVlkY5JqMSVejyR1p'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I want to cancel my non-refundable ticket. My booking reference is JKL012, and the flight number is DEF456.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_gUJ7j6oqLZ2ZdM6fSASz45tl', function=Function(arguments='{"booking_reference":"JKL012"}', name='check_ticket_type'), type='function')]), {'role': 'tool', 'content': 'Ticket type: nonrefundable
Fare rules: ', 'tool_call_id': 'call_gUJ7j6oqLZ2ZdM6fSASz45tl'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_yTVgf46ATUVDblj6bAuMG1ER', function=Function(arguments='{"booking_reference":"JKL012"}', name='offer_flight_credit'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'I want to cancel my non-refundable ticket.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"ABC123","full_name":"John Doe","flight_number":"XY123"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_2KR4YsRFVlkY5JqMSVejyR1p'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I want to cancel my non-refundable ticket. My booking reference is JKL012, and the flight number is DEF456.'}, {'role': 'assistant', 'tool_call': {'name': 'check_ticket_type', 'arguments': '{"booking_reference":"JKL012"}'}}, {'role': 'tool', 'content': 'Ticket type: nonrefundable
Fare rules: ', 'tool_call_id': 'call_gUJ7j6oqLZ2ZdM6fSASz45tl'}, {'role': 'assistant', 'tool_call': {'name': 'offer_flight_credit', 'arguments': '{"booking_reference":"JKL012"}'}}]</td>
    </tr>
    <tr>
      <th>4</th>
      <td>I want to cancel my refundable ticket.</td>
      <td>I want to cancel my flight and I believe it is refundable.</td>
      <td>process_partial_refund</td>
      <td>{'booking_reference': 'MNO345', 'refund_amount': 65}</td>
      <td>process_full_refund</td>
      <td>{'booking_reference': 'MNO345'}</td>
      <td>False</td>
      <td>[{'role': 'user', 'content': 'I want to cancel my refundable ticket.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_EUNyDQYoiDd9RypLpnh4wGKC', function=Function(arguments='{"booking_reference":"ABC123","full_name":"John Doe","flight_number":"XY123"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_EUNyDQYoiDd9RypLpnh4wGKC'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I just want to cancel my refundable ticket. My booking reference is MNO345, and the flight number is STU678.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_dok8wgfeEqhvyaeipe0V0K1C', function=Function(arguments='{"booking_reference":"MNO345"}', name='check_ticket_type'), type='function')]), {'role': 'tool', 'content': 'Ticket type: refundable
Fare rules: partial_refund', 'tool_call_id': 'call_dok8wgfeEqhvyaeipe0V0K1C'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_e6y9o2uFbTChVq6TnTxEPwgJ', function=Function(arguments='{"booking_reference":"MNO345"}', name='process_full_refund'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'I want to cancel my refundable ticket.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"ABC123","full_name":"John Doe","flight_number":"XY123"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_EUNyDQYoiDd9RypLpnh4wGKC'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I just want to cancel my refundable ticket. My booking reference is MNO345, and the flight number is STU678.'}, {'role': 'assistant', 'tool_call': {'name': 'check_ticket_type', 'arguments': '{"booking_reference":"MNO345"}'}}, {'role': 'tool', 'content': 'Ticket type: refundable
Fare rules: partial_refund', 'tool_call_id': 'call_dok8wgfeEqhvyaeipe0V0K1C'}, {'role': 'assistant', 'tool_call': {'name': 'process_full_refund', 'arguments': '{"booking_reference":"MNO345"}'}}]</td>
    </tr>
    <tr>
      <th>5</th>
      <td>I missed my connecting flight because of the airline delay.</td>
      <td>I want to address the issue of missing my connecting flight due to a delay caused by the airline.</td>
      <td>prioritize_missed_connections</td>
      <td>{'booking_reference': 'PQR678'}</td>
      <td>check_compensation_eligibility</td>
      <td>{'booking_reference': 'PQR678'}</td>
      <td>False</td>
      <td>[{'role': 'user', 'content': 'I missed my connecting flight because of the airline delay.'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to inquire about compensation for my missed connecting flight. My booking reference is PQR678, and my flight number is LMN789.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_m14oI2Ao69Uf2LtTlw2BH70k', function=Function(arguments='{"booking_reference":"PQR678","full_name":"","flight_number":"LMN789"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_m14oI2Ao69Uf2LtTlw2BH70k'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_77kNs4MwK23SSy2DM2fJoyXV', function=Function(arguments='{"booking_reference":"PQR678"}', name='check_compensation_eligibility'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'I missed my connecting flight because of the airline delay.'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to inquire about compensation for my missed connecting flight. My booking reference is PQR678, and my flight number is LMN789.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"PQR678","full_name":"","flight_number":"LMN789"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_m14oI2Ao69Uf2LtTlw2BH70k'}, {'role': 'assistant', 'tool_call': {'name': 'check_compensation_eligibility', 'arguments': '{"booking_reference":"PQR678"}'}}]</td>
    </tr>
    <tr>
      <th>6</th>
      <td>I want to know if I am eligible for compensation because of a long delay.</td>
      <td>I want to know if I can receive compensation due to a long delay on my flight.</td>
      <td>check_compensation_eligibility</td>
      <td>{'booking_reference': 'STU901'}</td>
      <td>check_compensation_eligibility</td>
      <td>{'booking_reference': 'STU901'}</td>
      <td>True</td>
      <td>[{'role': 'user', 'content': 'I want to know if I am eligible for compensation because of a long delay.'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to inquire about compensation for my flight due to a long delay. My booking reference is STU901 and my flight number is ABC789.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_OwUcDUdh7iRtlnDMgejl9mwi', function=Function(arguments='{"booking_reference":"STU901","full_name":"","flight_number":"ABC789"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_OwUcDUdh7iRtlnDMgejl9mwi'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_OxbUhGFKy6V2m4gBGeEUuLtL', function=Function(arguments='{"booking_reference":"STU901"}', name='check_compensation_eligibility'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'I want to know if I am eligible for compensation because of a long delay.'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to inquire about compensation for my flight due to a long delay. My booking reference is STU901 and my flight number is ABC789.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"STU901","full_name":"","flight_number":"ABC789"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_OwUcDUdh7iRtlnDMgejl9mwi'}, {'role': 'assistant', 'tool_call': {'name': 'check_compensation_eligibility', 'arguments': '{"booking_reference":"STU901"}'}}]</td>
    </tr>
    <tr>
      <th>7</th>
      <td>I would like to rebook my flight.</td>
      <td>I want to rebook my flight, and I have provided my details for verification.</td>
      <td>process_change_no_fee</td>
      <td>{'booking_reference': 'VWX234', 'new_flight': 'LMG091'}</td>
      <td>process_change_no_fee</td>
      <td>{'booking_reference': 'VWX234'}</td>
      <td>False</td>
      <td>[{'role': 'user', 'content': 'I would like to rebook my flight.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_dY7ZAsWA7xUhN1xfeJ3xjcUn', function=Function(arguments='{"booking_reference":"ABC123","full_name":"John Doe","flight_number":"XY123"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_dY7ZAsWA7xUhN1xfeJ3xjcUn'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to change my flight. My booking reference is VWX234 and my flight number is XYZ345. What do you need from me to proceed?'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I apologize for any confusion. I would like to change my flight. My booking reference is VWX234, and my flight number is XYZ345. Please let me know what further information you need to proceed with the rebooking.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_QbOuJJbRtoG4DbTbGEzqD9IN', function=Function(arguments='{"booking_reference":"VWX234"}', name='check_ticket_type'), type='function')]), {'role': 'tool', 'content': 'Ticket type: flexible
Fare rules: ', 'tool_call_id': 'call_QbOuJJbRtoG4DbTbGEzqD9IN'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_qYUzreGS25HZDgZ0IZiYZC2r', function=Function(arguments='{"booking_reference":"VWX234"}', name='process_change_no_fee'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'I would like to rebook my flight.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"ABC123","full_name":"John Doe","flight_number":"XY123"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_dY7ZAsWA7xUhN1xfeJ3xjcUn'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to change my flight. My booking reference is VWX234 and my flight number is XYZ345. What do you need from me to proceed?'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I apologize for any confusion. I would like to change my flight. My booking reference is VWX234, and my flight number is XYZ345. Please let me know what further information you need to proceed with the rebooking.'}, {'role': 'assistant', 'tool_call': {'name': 'check_ticket_type', 'arguments': '{"booking_reference":"VWX234"}'}}, {'role': 'tool', 'content': 'Ticket type: flexible
Fare rules: ', 'tool_call_id': 'call_QbOuJJbRtoG4DbTbGEzqD9IN'}, {'role': 'assistant', 'tool_call': {'name': 'process_change_no_fee', 'arguments': '{"booking_reference":"VWX234"}'}}]</td>
    </tr>
    <tr>
      <th>8</th>
      <td>I want to cancel my flight because of a medical emergency.</td>
      <td>I want to cancel my flight due to a medical emergency.</td>
      <td>process_flexible_cancellation</td>
      <td>{'booking_reference': 'YZA567', 'medical_certificate': 'MC1234'}</td>
      <td>process_flexible_cancellation</td>
      <td>{'booking_reference': 'ABC123', 'medical_certificate': 'Medical certificate provided by the customer.'}</td>
      <td>False</td>
      <td>[{'role': 'user', 'content': 'I want to cancel my flight because of a medical emergency.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_X77ADxzETcqjfUWCkCOy8UFd', function=Function(arguments='{"booking_reference":"ABC123","full_name":"John Doe","flight_number":"XY123"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_X77ADxzETcqjfUWCkCOy8UFd'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_veSQUPRiHD3Uq0OPNY5YxVcx', function=Function(arguments='{"booking_reference":"ABC123","medical_certificate":"Medical certificate provided by the customer."}', name='process_flexible_cancellation'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'I want to cancel my flight because of a medical emergency.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"ABC123","full_name":"John Doe","flight_number":"XY123"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_X77ADxzETcqjfUWCkCOy8UFd'}, {'role': 'assistant', 'tool_call': {'name': 'process_flexible_cancellation', 'arguments': '{"booking_reference":"ABC123","medical_certificate":"Medical certificate provided by the customer."}'}}]</td>
    </tr>
    <tr>
      <th>9</th>
      <td>I would like to change the passenger name on my group booking.</td>
      <td>I want to change the name of one of the passengers in my group booking.</td>
      <td>permit_name_change</td>
      <td>{'booking_reference': 'BCD890'}</td>
      <td>permit_name_change</td>
      <td>{'booking_reference': 'BCD890'}</td>
      <td>True</td>
      <td>[{'role': 'user', 'content': 'I would like to change the passenger name on my group booking.'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to change the passenger name on my group booking. The booking reference is BCD890, and the flight number is QRS123. Please let me know what information you need to process this change.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_2xigMe9WCuk6LrbrOCRbOGGW', function=Function(arguments='{"booking_reference":"BCD890","full_name":"","flight_number":"QRS123"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_2xigMe9WCuk6LrbrOCRbOGGW'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_U7PPV0juECH5DVmnwPwxRx1y', function=Function(arguments='{"booking_reference":"BCD890"}', name='permit_name_change'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'I would like to change the passenger name on my group booking.'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to change the passenger name on my group booking. The booking reference is BCD890, and the flight number is QRS123. Please let me know what information you need to process this change.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"BCD890","full_name":"","flight_number":"QRS123"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_2xigMe9WCuk6LrbrOCRbOGGW'}, {'role': 'assistant', 'tool_call': {'name': 'permit_name_change', 'arguments': '{"booking_reference":"BCD890"}'}}]</td>
    </tr>
    <tr>
      <th>10</th>
      <td>The airline canceled my flight, and I need a hotel for the night.</td>
      <td>I want to find a hotel because my flight was canceled by the airline.</td>
      <td>offer_accommodation</td>
      <td>{'booking_reference': 'EFG123'}</td>
      <td>rebook_without_fee</td>
      <td>{'booking_reference': 'ABC123'}</td>
      <td>False</td>
      <td>[{'role': 'user', 'content': 'The airline canceled my flight, and I need a hotel for the night.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_Jv6XGz3K00phTaVVgKGt5sVO', function=Function(arguments='{"booking_reference":"ABC123","full_name":"John Doe","flight_number":"XY123"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_Jv6XGz3K00phTaVVgKGt5sVO'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_EoA57oSQpmBOiaYXldok2s1F', function=Function(arguments='{"booking_reference":"ABC123"}', name='rebook_without_fee'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'The airline canceled my flight, and I need a hotel for the night.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"ABC123","full_name":"John Doe","flight_number":"XY123"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_Jv6XGz3K00phTaVVgKGt5sVO'}, {'role': 'assistant', 'tool_call': {'name': 'rebook_without_fee', 'arguments': '{"booking_reference":"ABC123"}'}}]</td>
    </tr>
    <tr>
      <th>11</th>
      <td>I need to change my flight within the next 7 days.</td>
      <td>I want to change my flight because it's within the next week and I hope I can do it without any extra fees.</td>
      <td>process_change_no_fee</td>
      <td>{'booking_reference': 'GHI123', 'new_flight': 'LMG091'}</td>
      <td>apply_change_fee</td>
      <td>{'booking_reference': 'GHI123'}</td>
      <td>False</td>
      <td>[{'role': 'user', 'content': 'I need to change my flight within the next 7 days.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_q05m3J5Ai0DJGewINZIZax0F', function=Function(arguments='{"booking_reference":"ABC123","full_name":"John Doe","flight_number":"XY123"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_q05m3J5Ai0DJGewINZIZax0F'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to change my flight. My booking reference is GHI123, and the flight number is PQR789.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_3NDVVAed3LkGgPeKAFHhIBTu', function=Function(arguments='{"booking_reference":"GHI123"}', name='check_ticket_type'), type='function')]), {'role': 'tool', 'content': 'Ticket type: flexible
Fare rules: ', 'tool_call_id': 'call_3NDVVAed3LkGgPeKAFHhIBTu'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_c2J2lyOXB782kGrCBl2WyNDh', function=Function(arguments='{"booking_reference":"GHI123"}', name='apply_change_fee'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'I need to change my flight within the next 7 days.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"ABC123","full_name":"John Doe","flight_number":"XY123"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_q05m3J5Ai0DJGewINZIZax0F'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to change my flight. My booking reference is GHI123, and the flight number is PQR789.'}, {'role': 'assistant', 'tool_call': {'name': 'check_ticket_type', 'arguments': '{"booking_reference":"GHI123"}'}}, {'role': 'tool', 'content': 'Ticket type: flexible
Fare rules: ', 'tool_call_id': 'call_3NDVVAed3LkGgPeKAFHhIBTu'}, {'role': 'assistant', 'tool_call': {'name': 'apply_change_fee', 'arguments': '{"booking_reference":"GHI123"}'}}]</td>
    </tr>
    <tr>
      <th>12</th>
      <td>I want to change my non-flexible flight to a different date.</td>
      <td>I want to change my flight date, but I know my ticket is non-flexible which might incur a fee.</td>
      <td>apply_change_fee</td>
      <td>{'booking_reference': 'JKL234'}</td>
      <td>apply_change_fee</td>
      <td>{'booking_reference': 'JKL234'}</td>
      <td>True</td>
      <td>[{'role': 'user', 'content': 'I want to change my non-flexible flight to a different date.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_1sty9ezGaZFSCt2eQTeIhkxC', function=Function(arguments='{"booking_reference":"ABC123","full_name":"John Doe","flight_number":"XY123"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_1sty9ezGaZFSCt2eQTeIhkxC'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to change my non-flexible flight to a different date. My booking reference is JKL234, and my flight number is STU567.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_l6fhcGmpMYioWQrPSt2JdeNd', function=Function(arguments='{"booking_reference":"JKL234"}', name='check_ticket_type'), type='function')]), {'role': 'tool', 'content': 'Ticket type: nonrefundable
Fare rules: ', 'tool_call_id': 'call_l6fhcGmpMYioWQrPSt2JdeNd'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_f21zxsntIxnAViaSEj8ue9gs', function=Function(arguments='{"booking_reference":"JKL234"}', name='apply_change_fee'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'I want to change my non-flexible flight to a different date.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"ABC123","full_name":"John Doe","flight_number":"XY123"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_1sty9ezGaZFSCt2eQTeIhkxC'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to change my non-flexible flight to a different date. My booking reference is JKL234, and my flight number is STU567.'}, {'role': 'assistant', 'tool_call': {'name': 'check_ticket_type', 'arguments': '{"booking_reference":"JKL234"}'}}, {'role': 'tool', 'content': 'Ticket type: nonrefundable
Fare rules: ', 'tool_call_id': 'call_l6fhcGmpMYioWQrPSt2JdeNd'}, {'role': 'assistant', 'tool_call': {'name': 'apply_change_fee', 'arguments': '{"booking_reference":"JKL234"}'}}]</td>
    </tr>
    <tr>
      <th>13</th>
      <td>The airline canceled my flight due to weather. Can I get rebooked?</td>
      <td>I want to get rebooked on a flight since my original flight was canceled due to weather.</td>
      <td>rebook_without_fee</td>
      <td>{'booking_reference': 'MNO345'}</td>
      <td>rebook_without_fee</td>
      <td>{'booking_reference': 'ABC123'}</td>
      <td>False</td>
      <td>[{'role': 'user', 'content': 'The airline canceled my flight due to weather. Can I get rebooked?'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_rJf9tgr1x2ln67FfiF10TOEM', function=Function(arguments='{"booking_reference":"ABC123","full_name":"John Doe","flight_number":"XY123"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_rJf9tgr1x2ln67FfiF10TOEM'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_uWyWKOxJpILCykvsD7ue9VqR', function=Function(arguments='{"booking_reference":"ABC123"}', name='rebook_without_fee'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'The airline canceled my flight due to weather. Can I get rebooked?'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"ABC123","full_name":"John Doe","flight_number":"XY123"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_rJf9tgr1x2ln67FfiF10TOEM'}, {'role': 'assistant', 'tool_call': {'name': 'rebook_without_fee', 'arguments': '{"booking_reference":"ABC123"}'}}]</td>
    </tr>
    <tr>
      <th>14</th>
      <td>I need a refund for my non-refundable flight.</td>
      <td>I want to cancel my flight but I think it is non-refundable.</td>
      <td>offer_flight_credit</td>
      <td>{'booking_reference': 'PQR567'}</td>
      <td>offer_flight_credit</td>
      <td>{'booking_reference': 'PQR567'}</td>
      <td>True</td>
      <td>[{'role': 'user', 'content': 'I need a refund for my non-refundable flight.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_8PruExtHWO2aCIrCtF6BNTMk', function=Function(arguments='{"booking_reference":"ABC123","full_name":"John Doe","flight_number":"XY123"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_8PruExtHWO2aCIrCtF6BNTMk'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I want to cancel my flight. My booking reference is PQR567, and my flight number is XYZ456.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_c84uUAPlE6Gs3SywpBwEJDY4', function=Function(arguments='{"booking_reference":"PQR567"}', name='check_ticket_type'), type='function')]), {'role': 'tool', 'content': 'Ticket type: nonrefundable
Fare rules: ', 'tool_call_id': 'call_c84uUAPlE6Gs3SywpBwEJDY4'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_X6XYy4LlEqqc6So50da56b9Q', function=Function(arguments='{"booking_reference":"PQR567"}', name='offer_flight_credit'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'I need a refund for my non-refundable flight.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"ABC123","full_name":"John Doe","flight_number":"XY123"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_8PruExtHWO2aCIrCtF6BNTMk'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I want to cancel my flight. My booking reference is PQR567, and my flight number is XYZ456.'}, {'role': 'assistant', 'tool_call': {'name': 'check_ticket_type', 'arguments': '{"booking_reference":"PQR567"}'}}, {'role': 'tool', 'content': 'Ticket type: nonrefundable
Fare rules: ', 'tool_call_id': 'call_c84uUAPlE6Gs3SywpBwEJDY4'}, {'role': 'assistant', 'tool_call': {'name': 'offer_flight_credit', 'arguments': '{"booking_reference":"PQR567"}'}}]</td>
    </tr>
    <tr>
      <th>15</th>
      <td>I need a refund for a flight I booked a few hours ago.</td>
      <td>I want to get a refund for a recently booked flight and I have provided the necessary details to verify my booking.</td>
      <td>process_full_refund</td>
      <td>{'booking_reference': 'STU678'}</td>
      <td>None</td>
      <td>None</td>
      <td>False</td>
      <td>[{'role': 'user', 'content': 'I need a refund for a flight I booked a few hours ago.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_m9RYVKrq2odCJLbQ11rkCnv2', function=Function(arguments='{"booking_reference":"ABC123","full_name":"John Doe","flight_number":"XY123"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_m9RYVKrq2odCJLbQ11rkCnv2'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to get a refund for my flight. Here are my booking details: 

- Booking Reference: STU678
- Flight Number: ABC345

Please let me know what additional information you need.'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to get a refund for my flight. Here are my booking details: 

- Booking Reference: STU678
- Flight Number: ABC345

Please let me know what additional information you need.'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to get a refund for my flight. Here are my booking details:

- Booking Reference: STU678
- Flight Number: ABC345

Please let me know what additional information you need.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_VOaLEEg1tElyE6562LLaYw2q', function=Function(arguments='{"booking_reference":"STU678","full_name":"John Doe","flight_number":"ABC345"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_VOaLEEg1tElyE6562LLaYw2q'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to get a refund for my flight. Here are my booking details:

- Booking Reference: STU678
- Flight Number: ABC345

If you need any more information or documentation to process my refund, please let me know.'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to get a refund for my flight. Here are my booking details:

- Booking Reference: STU678
- Flight Number: ABC345

If you need any more information or documentation to process my refund, please let me know.'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to get a refund for my flight. Here are my booking details:

- Booking Reference: STU678
- Flight Number: ABC345

If you need any more information or documentation to process my refund, please let me know.'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to get a refund for my flight. Here are my booking details:

- Booking Reference: STU678
- Flight Number: ABC345

If you need any more information or documentation to process my refund, please let me know.'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to get a refund for my flight. Here are my booking details:

- Booking Reference: STU678
- Flight Number: ABC345

If you need any more information or documentation to process my refund, please let me know.'}]</td>
      <td>[{'role': 'user', 'content': 'I need a refund for a flight I booked a few hours ago.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"ABC123","full_name":"John Doe","flight_number":"XY123"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_m9RYVKrq2odCJLbQ11rkCnv2'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to get a refund for my flight. Here are my booking details: 

- Booking Reference: STU678
- Flight Number: ABC345

Please let me know what additional information you need.'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to get a refund for my flight. Here are my booking details: 

- Booking Reference: STU678
- Flight Number: ABC345

Please let me know what additional information you need.'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to get a refund for my flight. Here are my booking details:

- Booking Reference: STU678
- Flight Number: ABC345

Please let me know what additional information you need.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"STU678","full_name":"John Doe","flight_number":"ABC345"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_VOaLEEg1tElyE6562LLaYw2q'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to get a refund for my flight. Here are my booking details:

- Booking Reference: STU678
- Flight Number: ABC345

If you need any more information or documentation to process my refund, please let me know.'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to get a refund for my flight. Here are my booking details:

- Booking Reference: STU678
- Flight Number: ABC345

If you need any more information or documentation to process my refund, please let me know.'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to get a refund for my flight. Here are my booking details:

- Booking Reference: STU678
- Flight Number: ABC345

If you need any more information or documentation to process my refund, please let me know.'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to get a refund for my flight. Here are my booking details:

- Booking Reference: STU678
- Flight Number: ABC345

If you need any more information or documentation to process my refund, please let me know.'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to get a refund for my flight. Here are my booking details:

- Booking Reference: STU678
- Flight Number: ABC345

If you need any more information or documentation to process my refund, please let me know.'}]</td>
    </tr>
    <tr>
      <th>16</th>
      <td>I missed my connecting flight because of a delay. Can I get rebooked?</td>
      <td>I want to get rebooked on another flight because I missed my connecting flight due to a delay.</td>
      <td>prioritize_missed_connections</td>
      <td>{'booking_reference': 'XYZ901'}</td>
      <td>prioritize_missed_connections</td>
      <td>{'booking_reference': 'XYZ901'}</td>
      <td>True</td>
      <td>[{'role': 'user', 'content': 'I missed my connecting flight because of a delay. Can I get rebooked?'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to get rebooked on another flight, please. My booking reference is XYZ901 and my flight number is LMN456.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_9bpzGS0YHhfUMsNNKJ5M33AV', function=Function(arguments='{"booking_reference":"XYZ901","full_name":"","flight_number":"LMN456"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_9bpzGS0YHhfUMsNNKJ5M33AV'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_4EVIr565fDsTCdbiOXR9z2AV', function=Function(arguments='{"booking_reference":"XYZ901"}', name='prioritize_missed_connections'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'I missed my connecting flight because of a delay. Can I get rebooked?'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to get rebooked on another flight, please. My booking reference is XYZ901 and my flight number is LMN456.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"XYZ901","full_name":"","flight_number":"LMN456"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_9bpzGS0YHhfUMsNNKJ5M33AV'}, {'role': 'assistant', 'tool_call': {'name': 'prioritize_missed_connections', 'arguments': '{"booking_reference":"XYZ901"}'}}]</td>
    </tr>
  </tbody>
</table>
</div>



```python
display_row(8)
```

    Eval DataFrame Row:
    ID                                                                                 8
    context                       I want to cancel my flight due to a medical emergency.
    request                   I want to cancel my flight because of a medical emergency.
    full_name                                                                Laura Adams
    booking_ref                                                                   YZA567
    flight_no                                                                     PQR678
    expected_function                                      process_flexible_cancellation
    expected_inputs        {"booking_reference":"YZA567","medical_certificate":"MC1234"}
    ticket_type                                                                 flexible
    fare_rules                                                                       NaN
    medical_certificate                                                           MC1234
    refund_amount                                                                    NaN
    Name: 8, dtype: object
    
    DataFrame Columns:
    actual_function: process_flexible_cancellation
    actual_inputs: {'booking_reference': 'ABC123', 'medical_certificate': 'Medical certificate provided by the customer.'}
    is_correct: False
    transcript:
    [34m{'role': 'user', 'content': 'I want to cancel my flight because of a medical emergency.'}[0m
    [31m{'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"ABC123","full_name":"John Doe","flight_number":"XY123"}'}}[0m
    [31m{'role': 'tool', 'content': 'True', 'tool_call_id': 'call_X77ADxzETcqjfUWCkCOy8UFd'}[0m
    [31m{'role': 'assistant', 'tool_call': {'name': 'process_flexible_cancellation', 'arguments': '{"booking_reference":"ABC123","medical_certificate":"Medical certificate provided by the customer."}'}}[0m


## Step 3: Improve 4o routine

Let's now leverage o1 again to add in a metaprompting loop to see if we can improve the quality of our evals.

We'll take the following multi-step approach:
- We'll pass in the current routine + eval results to o1 and ask it analyze the results and update the routine accordingly
- Since o1 does not currently support structured outputs, we'll chain with output with a 4o to enforce a schema we can parse
- Finally, we take the new routine and run it back through our eval to generate new results

We'll run this loop a fixed number of times and see what improvements we can make


```python
def get_openai_response(messages, model, response_format=None):
    try:
        if response_format:
            response = client.chat.completions.create(
                model=model,
                messages=messages,
                response_format={"type": "json_schema", "json_schema": response_format}
            )
        else:
            response = client.chat.completions.create(
                model=model,
                messages=messages
            )
        return response.choices[0].message.content
    except Exception as e:
        print(f"An error occurred: {e}")


OUTPUT_SCHEMA = {
                    "name": "policy_output",
                    "schema": {
                    "type": "object",
                    "properties": {
                        "final_answer": { "type": "string" }
                    },
                    "required": ["final_answer"],
                    "additionalProperties": False
                    },
                    "strict": True
                }
```

```
start_o1_message = [
    {
        "role": "user",
        "content": f"""# 指令
你是一个负责改进提供给客户服务LLM代理的指令质量的代理。
你的任务是改进提供给LLM代理的指令，以提高在测试集上的准确性，同时遵守初始政策。

## 标准
- 分析现有指令和评估结果。了解哪些行为导致了失败。
- 例如，如果LLM代理在需要时没有询问预订参考号，你应该添加一个步骤来请求预订参考号。
- 改进指令以解决评估结果中的差距。
- 确保所做的更改符合原始政策。
- 仅使用提供的工具。
- 尽最大努力使用提供的函数，以确保LLM代理能够有效处理客户服务请求。包括在必要时收集数据。
- 如果当前格式效果不佳，尝试更改格式 - 考虑使用基本的XML（例如<step> <substep> <if> <case>）或Markdown作为替代方案。

你将获得4项内容：
1) 客户服务代理的基准政策，包含如何处理航班取消和变更的详细指令。
2) 可用函数的完整列表。
3) 一套例行指令集。
4) 使用此例行指令集的LLM在测试集上的表现结果。该数据集包含以下列：
    - request: 这是用户的初始请求。
    - expected_function: 这是我们期望LLM在对话结束时调用的函数。
    - expected_input: 这是我们期望LLM在对话结束时提供给函数的输入。
    - actual_function: 这是LLM使用当前指令调用的最终函数。
    - actual_input: 这是LLM根据当前指令提供的函数参数。
    - transcript: 这是用户与LLM代理之间的对话记录。
    - is_correct: 根据模型是否正确响应，值为True/False。

你可能会获得编辑和评估的历史记录。你可以使用这些信息来了解之前尝试过什么，以及哪些方法有效或无效。

# 数据

## 1. 原始政策
{flight_cancellation_policy}

## 2. 函数
{TOOLS}

# 结论

返回改进后的政策，严格按照定义的JSON格式编写。删除LLM回答中不属于政策的所有部分，并且不要创建额外的键。
"""
     }
]
```




```python
start_o1_message = [
    {
        "role": "user",
        "content": f"""# Instructions
You are an agent that is responsible for improving the quality of instructions that are provided to a customer service LLM agent. 
Your task is to improve the instructions that are provided to the LLM agent in order to increase accuracy on a test set while adhering to the initial policy. 

## Criteria
- Analyze the existing instructions and the results of the eval. Understand which behaviors lead to failures.
- For example, if the LLM agent is not asking for the booking reference when it is needed, you should add a step to ask for the booking reference.
- Improve the instructions to address the gaps in the eval results.
- Ensure changes made are compliant with the original policy.
- Only use the tools provided.
- Use the functions provided to the best of your ability to ensure the LLM agent can handle the customer service requests effectively. Including gathering data where necessary.
- Try changing the format if this formatting doesn't work well - consider basic XML (e.g. <step> <substep> <if> <case>) or markdown as alternatives.

You will be provided with 4 items:
1) The ground-truth policy for the customer service agent containing detailed instructions on how to handle flight cancellations and changes.
2) Full list of available functions.
3) A routine instruction set.
4) A results that shows the LLMs performance on a test set using this routine instruction set. This dataset contains columns showing:
    - request: This is the initial user request. 
    - expected_function: This is the function we expect the LLM to call at the end of the conversation. 
    - expected_input: This is the input we expect the LLM to provide to the function at the end of the conversation.
    - actual_function: This is the final function the LLM called using the current instructions.
    - actual_input: These are the function parameters the LLM provided based on the current instructions.
    - transcript: This is the conversation transcript between the user and the LLM agent. 
    - is_correct: True/False value depending on if the model responded correctly

You may be provided with a history of edits and evaluations. You can use this information to understand what has been tried before and what has worked or not worked.

# Data

## 1. Original policy
{flight_cancellation_policy}

## 2. Functions
{TOOLS}

# Conclusion

Return the improved policy exactly as written within the defined JSON. Remove all parts from the LLM's answer that are not part of the policy, and do not create additional keys.
"""
     }
]
```


```python
import tiktoken 

encoding = tiktoken.get_encoding("o200k_base")

def num_tokens_from_messages(messages):
    entire_input = ""
    for message in messages:
        entire_input += message["content"] + " "
    tokens = encoding.encode(entire_input)
    return len(tokens)
```

When improving the routine, consider these approaches:
- Adding synthetic examples to show the model how to choose between two commonly mistaken functions
- Given it general guidance on what attributes to look out for which it commonly mislabels
- Being more specific with your guidance on how to follow the routine.

<p style="background-color:#f7fff8; padding:15px; border-width:3px; border-color:#e0f0e0; border-style:solid; border-radius:6px"> 🚨
&nbsp; <b>High Token Warning!:</b> Running the following cell consumes many tokens. Running multiple times may result in a message regarding exceeding a monthy quota.</p>


```python
# start with data from first run
routines = [flight_cancellation_routine]
results = [df]
accuracies = [round(accuracy * 100, 2)]
o1_messages = start_o1_message.copy()

MAX_TOKENS = 120000

for i in range(3):
    display(Markdown(f"## Iteration {i+1}"))
    
    # Build a candidate message with the most recent eval (full table)
    prev_results = results[-1]
    pf = prev_results.drop(columns=['transcript'])

    new_eval_content = (
        f"## 3. Routine instructions:\n"
        f"{routines[-1]}\n"
        f"## 4. Results table:\n"
        f"{pf.to_json(orient='records')}\n"
    )
    
    # Check token count before adding the newest eval
    candidate_messages = o1_messages + [{"role": "user", "content": new_eval_content}]
    if num_tokens_from_messages(candidate_messages) <= MAX_TOKENS:
        o1_messages.append({"role":"user", "content": new_eval_content})
    else:
        # If we can't even fit the newest eval, consider truncation or error handling
        # For simplicity, we skip truncation logic here
        print("excluding eval content {num_tokens_from_messages(candidate_messages)}")
        pass

    print(f"num tokens {num_tokens_from_messages(o1_messages)}")
    print(f"len messages {len(o1_messages)}")


    # Get the updated routine from the metaprompting assistant
    temp_routine_json = get_openai_response(o1_messages
                                            , O1_MODEL
                                            ,response_format=OUTPUT_SCHEMA)
    #temp_routine_str = temp_routine_json.strip("json```").strip("```")
    new_routine = json.loads(temp_routine_json)["final_answer"]
    routines.append(new_routine)

    eval_df = pd.read_csv('evals/policyEvals.csv')

    # Evaluate the function calls with the current policy on the gpt-4o model
    eval_df, accuracy = evaluate_function_calls(
        eval_df,
        new_routine,
        GPT_MODEL,
        i
    )
    accuracies.append(round(accuracy * 100, 2))
    results.append(eval_df)
    display(Markdown(f"### Accuracy: {accuracy:.2%}"))

    #list the IDs of the failed rows
    failed_ids = eval_df[eval_df['is_correct'] == False].index.tolist()
    display(eval_df.loc[failed_ids])
    eval_df.to_csv(f'evals/results_run_{i+1}.csv', index=False)

    # Instantiate fresh o1 message
    o1_messages = start_o1_message.copy()

    # Attempt to include older examples (omitting 'transcript') within token limit
    older_results = results[:-1][::-1]  # all except the newest, reversed for most recent first
    for old_eval_df in older_results:
        if 'transcript' in old_eval_df.columns:
            truncated_df = old_eval_df.drop(columns=['transcript','cleaned_transcript'])
        else:
            truncated_df = old_eval_df

        old_content = "## Older eval (no transcript):\n" + truncated_df.to_json(orient='records')
        candidate_messages = o1_messages + [{"role": "user", "content": old_content}]
        if num_tokens_from_messages(candidate_messages) <= MAX_TOKENS:
            o1_messages.append({"role": "user", "content": old_content})
        else:
            # If we exceed token limits, stop adding older examples
            break

```


## Iteration 1


    num tokens 12345
    len messages 2



### Accuracy: 70.59%



<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>request</th>
      <th>context</th>
      <th>expected_function</th>
      <th>expected_inputs</th>
      <th>actual_function</th>
      <th>actual_inputs</th>
      <th>is_correct</th>
      <th>transcript</th>
      <th>cleaned_transcript</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>4</th>
      <td>I want to cancel my refundable ticket.</td>
      <td>I want to cancel my flight and I believe it is refundable.</td>
      <td>process_partial_refund</td>
      <td>{'booking_reference': 'MNO345', 'refund_amount': 65}</td>
      <td>process_full_refund</td>
      <td>{'booking_reference': 'MNO345'}</td>
      <td>False</td>
      <td>[{'role': 'user', 'content': 'I want to cancel my refundable ticket.'}, {'role': 'assistant', 'content': 'Could you please provide me with your booking reference, full name, and flight number so I can verify your identity?'}, {'role': 'user', 'content': 'My booking reference is MNO345, my name is Sarah Brown, and my flight number is STU678.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_pcTIy9RxEpiH8itn43EnOu9i', function=Function(arguments='{"booking_reference":"MNO345","full_name":"Sarah Brown","flight_number":"STU678"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_pcTIy9RxEpiH8itn43EnOu9i'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_YreVtwJaAxjsXkMicQhyl9o1', function=Function(arguments='{"booking_reference":"MNO345"}', name='check_ticket_type'), type='function')]), {'role': 'tool', 'content': 'Ticket type: refundable
Fare rules: partial_refund', 'tool_call_id': 'call_YreVtwJaAxjsXkMicQhyl9o1'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_AigRxRIrckGyjGaEIJDvQmQy', function=Function(arguments='{"booking_reference":"MNO345"}', name='process_full_refund'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'I want to cancel my refundable ticket.'}, {'role': 'assistant', 'content': 'Could you please provide me with your booking reference, full name, and flight number so I can verify your identity?'}, {'role': 'user', 'content': 'My booking reference is MNO345, my name is Sarah Brown, and my flight number is STU678.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"MNO345","full_name":"Sarah Brown","flight_number":"STU678"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_pcTIy9RxEpiH8itn43EnOu9i'}, {'role': 'assistant', 'tool_call': {'name': 'check_ticket_type', 'arguments': '{"booking_reference":"MNO345"}'}}, {'role': 'tool', 'content': 'Ticket type: refundable
Fare rules: partial_refund', 'tool_call_id': 'call_YreVtwJaAxjsXkMicQhyl9o1'}, {'role': 'assistant', 'tool_call': {'name': 'process_full_refund', 'arguments': '{"booking_reference":"MNO345"}'}}]</td>
    </tr>
    <tr>
      <th>5</th>
      <td>I missed my connecting flight because of the airline delay.</td>
      <td>I want to address the issue of missing my connecting flight due to a delay caused by the airline.</td>
      <td>prioritize_missed_connections</td>
      <td>{'booking_reference': 'PQR678'}</td>
      <td>prioritize_missed_connections</td>
      <td>{}</td>
      <td>False</td>
      <td>[{'role': 'user', 'content': 'I missed my connecting flight because of the airline delay.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_QT8dgiVXz8ilxqgOXq9vZGig', function=Function(arguments='{}', name='prioritize_missed_connections'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'I missed my connecting flight because of the airline delay.'}, {'role': 'assistant', 'tool_call': {'name': 'prioritize_missed_connections', 'arguments': '{}'}}]</td>
    </tr>
    <tr>
      <th>7</th>
      <td>I would like to rebook my flight.</td>
      <td>I want to rebook my flight, and I have provided my details for verification.</td>
      <td>process_change_no_fee</td>
      <td>{'booking_reference': 'VWX234', 'new_flight': 'LMG091'}</td>
      <td>process_change_no_fee</td>
      <td>{'booking_reference': 'VWX234', 'new_flight': 'XYZ678'}</td>
      <td>False</td>
      <td>[{'role': 'user', 'content': 'I would like to rebook my flight.'}, {'role': 'assistant', 'content': 'Could you please provide your booking reference, full name, and flight number so I can verify your identity?'}, {'role': 'user', 'content': 'My booking reference is VWX234, my flight number is XYZ345, and my name is Lucas Brown.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_223TP4A7jV3Gq2znDfKga9Fy', function=Function(arguments='{"booking_reference":"VWX234","full_name":"Lucas Brown","flight_number":"XYZ345"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_223TP4A7jV3Gq2znDfKga9Fy'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to change my flight to a later date.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_8kKrZAOhQNUKYKti7aKws1MN', function=Function(arguments='{"booking_reference":"VWX234"}', name='check_ticket_type'), type='function')]), {'role': 'tool', 'content': 'Ticket type: flexible
Fare rules: ', 'tool_call_id': 'call_8kKrZAOhQNUKYKti7aKws1MN'}, {'role': 'assistant', 'content': 'Since you have a flexible ticket, I can process the change without any fees. Please provide the new flight details or the flight code for the later date you would like to change to.'}, {'role': 'user', 'content': 'I would like to change my flight to XYZ678 on March 15, 2024.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_ev8aGlmeYay2knJJGzN3AjrC', function=Function(arguments='{"booking_reference":"VWX234","new_flight":"XYZ678"}', name='process_change_no_fee'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'I would like to rebook my flight.'}, {'role': 'assistant', 'content': 'Could you please provide your booking reference, full name, and flight number so I can verify your identity?'}, {'role': 'user', 'content': 'My booking reference is VWX234, my flight number is XYZ345, and my name is Lucas Brown.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"VWX234","full_name":"Lucas Brown","flight_number":"XYZ345"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_223TP4A7jV3Gq2znDfKga9Fy'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to change my flight to a later date.'}, {'role': 'assistant', 'tool_call': {'name': 'check_ticket_type', 'arguments': '{"booking_reference":"VWX234"}'}}, {'role': 'tool', 'content': 'Ticket type: flexible
Fare rules: ', 'tool_call_id': 'call_8kKrZAOhQNUKYKti7aKws1MN'}, {'role': 'assistant', 'content': 'Since you have a flexible ticket, I can process the change without any fees. Please provide the new flight details or the flight code for the later date you would like to change to.'}, {'role': 'user', 'content': 'I would like to change my flight to XYZ678 on March 15, 2024.'}, {'role': 'assistant', 'tool_call': {'name': 'process_change_no_fee', 'arguments': '{"booking_reference":"VWX234","new_flight":"XYZ678"}'}}]</td>
    </tr>
    <tr>
      <th>8</th>
      <td>I want to cancel my flight because of a medical emergency.</td>
      <td>I want to cancel my flight due to a medical emergency.</td>
      <td>process_flexible_cancellation</td>
      <td>{'booking_reference': 'YZA567', 'medical_certificate': 'MC1234'}</td>
      <td>process_flexible_cancellation</td>
      <td>{'booking_reference': 'YZA567', 'medical_certificate': 'Provided'}</td>
      <td>False</td>
      <td>[{'role': 'user', 'content': 'I want to cancel my flight because of a medical emergency.'}, {'role': 'assistant', 'content': 'Could you please provide me with your booking reference, full name, and flight number so I can verify your identity?'}, {'role': 'user', 'content': 'My booking reference is YZA567, my full name is Laura Adams, and my flight number is PQR678.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_tsR1xZ1f0ohPI3Z2W4APcPaA', function=Function(arguments='{"booking_reference":"YZA567","full_name":"Laura Adams","flight_number":"PQR678"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_tsR1xZ1f0ohPI3Z2W4APcPaA'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_ywFsNpRgC52AGeh1sb7x9DyA', function=Function(arguments='{"booking_reference":"YZA567","medical_certificate":"Provided"}', name='process_flexible_cancellation'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'I want to cancel my flight because of a medical emergency.'}, {'role': 'assistant', 'content': 'Could you please provide me with your booking reference, full name, and flight number so I can verify your identity?'}, {'role': 'user', 'content': 'My booking reference is YZA567, my full name is Laura Adams, and my flight number is PQR678.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"YZA567","full_name":"Laura Adams","flight_number":"PQR678"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_tsR1xZ1f0ohPI3Z2W4APcPaA'}, {'role': 'assistant', 'tool_call': {'name': 'process_flexible_cancellation', 'arguments': '{"booking_reference":"YZA567","medical_certificate":"Provided"}'}}]</td>
    </tr>
    <tr>
      <th>11</th>
      <td>I need to change my flight within the next 7 days.</td>
      <td>I want to change my flight because it's within the next week and I hope I can do it without any extra fees.</td>
      <td>process_change_no_fee</td>
      <td>{'booking_reference': 'GHI123', 'new_flight': 'LMG091'}</td>
      <td>apply_change_fee</td>
      <td>{'booking_reference': 'GHI123'}</td>
      <td>False</td>
      <td>[{'role': 'user', 'content': 'I need to change my flight within the next 7 days.'}, {'role': 'assistant', 'content': 'Could you please provide me with your booking reference, full name, and flight number so I can verify your identity?'}, {'role': 'user', 'content': 'Sure! My booking reference is GHI123, my full name is Lisa Brown, and my flight number is PQR789.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_bBwZZQJW5092wu6tSOw0mWEN', function=Function(arguments='{"booking_reference":"GHI123","full_name":"Lisa Brown","flight_number":"PQR789"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_bBwZZQJW5092wu6tSOw0mWEN'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_Cu0yXFR1vUcDFWE923erynBn', function=Function(arguments='{"booking_reference":"GHI123"}', name='check_ticket_type'), type='function')]), {'role': 'tool', 'content': 'Ticket type: flexible
Fare rules: ', 'tool_call_id': 'call_Cu0yXFR1vUcDFWE923erynBn'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_Q3W1ZdKjiDyf0k9YgG4NKWJA', function=Function(arguments='{"booking_reference":"GHI123"}', name='apply_change_fee'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'I need to change my flight within the next 7 days.'}, {'role': 'assistant', 'content': 'Could you please provide me with your booking reference, full name, and flight number so I can verify your identity?'}, {'role': 'user', 'content': 'Sure! My booking reference is GHI123, my full name is Lisa Brown, and my flight number is PQR789.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"GHI123","full_name":"Lisa Brown","flight_number":"PQR789"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_bBwZZQJW5092wu6tSOw0mWEN'}, {'role': 'assistant', 'tool_call': {'name': 'check_ticket_type', 'arguments': '{"booking_reference":"GHI123"}'}}, {'role': 'tool', 'content': 'Ticket type: flexible
Fare rules: ', 'tool_call_id': 'call_Cu0yXFR1vUcDFWE923erynBn'}, {'role': 'assistant', 'tool_call': {'name': 'apply_change_fee', 'arguments': '{"booking_reference":"GHI123"}'}}]</td>
    </tr>
  </tbody>
</table>
</div>



## Iteration 2


    num tokens 14182
    len messages 3



### Accuracy: 70.59%



<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>request</th>
      <th>context</th>
      <th>expected_function</th>
      <th>expected_inputs</th>
      <th>actual_function</th>
      <th>actual_inputs</th>
      <th>is_correct</th>
      <th>transcript</th>
      <th>cleaned_transcript</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2</th>
      <td>My flight was canceled by the airline, and I want a refund.</td>
      <td>I want to request a refund because my flight was canceled by the airline due to weather.</td>
      <td>process_full_refund</td>
      <td>{'booking_reference': 'GHI789'}</td>
      <td>rebook_without_fee</td>
      <td>{'booking_reference': 'GHI789'}</td>
      <td>False</td>
      <td>[{'role': 'user', 'content': 'My flight was canceled by the airline, and I want a refund.'}, {'role': 'assistant', 'content': 'To assist you with your refund request, I first need to verify your identity. Please provide your booking reference, full name, and flight number.'}, {'role': 'user', 'content': 'My booking reference is GHI789, my full name is Emma Johnson, and my flight number is ABC123.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_oZM3dVhXl9S22Vwb6ZzDs8Qu', function=Function(arguments='{"booking_reference":"GHI789","full_name":"Emma Johnson","flight_number":"ABC123"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_oZM3dVhXl9S22Vwb6ZzDs8Qu'}, {'role': 'assistant', 'content': 'Thank you, Emma Johnson. Your identity has been verified.

Since your flight was canceled by the airline, I will now determine the reason for the cancellation. Please hold on for a moment. 

Could you please let me know if the cancellation was due to weather, mechanical issues, or operational changes?'}, {'role': 'user', 'content': 'The cancellation was due to weather conditions.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_VTJOkFFtNzjyC0TJ6ySFmyxa', function=Function(arguments='{"booking_reference":"GHI789"}', name='rebook_without_fee'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'My flight was canceled by the airline, and I want a refund.'}, {'role': 'assistant', 'content': 'To assist you with your refund request, I first need to verify your identity. Please provide your booking reference, full name, and flight number.'}, {'role': 'user', 'content': 'My booking reference is GHI789, my full name is Emma Johnson, and my flight number is ABC123.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"GHI789","full_name":"Emma Johnson","flight_number":"ABC123"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_oZM3dVhXl9S22Vwb6ZzDs8Qu'}, {'role': 'assistant', 'content': 'Thank you, Emma Johnson. Your identity has been verified.

Since your flight was canceled by the airline, I will now determine the reason for the cancellation. Please hold on for a moment. 

Could you please let me know if the cancellation was due to weather, mechanical issues, or operational changes?'}, {'role': 'user', 'content': 'The cancellation was due to weather conditions.'}, {'role': 'assistant', 'tool_call': {'name': 'rebook_without_fee', 'arguments': '{"booking_reference":"GHI789"}'}}]</td>
    </tr>
    <tr>
      <th>5</th>
      <td>I missed my connecting flight because of the airline delay.</td>
      <td>I want to address the issue of missing my connecting flight due to a delay caused by the airline.</td>
      <td>prioritize_missed_connections</td>
      <td>{'booking_reference': 'PQR678'}</td>
      <td>prioritize_missed_connections</td>
      <td>{'booking_reference': '12345'}</td>
      <td>False</td>
      <td>[{'role': 'user', 'content': 'I missed my connecting flight because of the airline delay.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_sHsMEGrqrk5NuzbGcTwbgw5R', function=Function(arguments='{"booking_reference":"12345"}', name='prioritize_missed_connections'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'I missed my connecting flight because of the airline delay.'}, {'role': 'assistant', 'tool_call': {'name': 'prioritize_missed_connections', 'arguments': '{"booking_reference":"12345"}'}}]</td>
    </tr>
    <tr>
      <th>7</th>
      <td>I would like to rebook my flight.</td>
      <td>I want to rebook my flight, and I have provided my details for verification.</td>
      <td>process_change_no_fee</td>
      <td>{'booking_reference': 'VWX234', 'new_flight': 'LMG091'}</td>
      <td>process_change_no_fee</td>
      <td>{'booking_reference': 'VWX234', 'new_flight': 'FR9876'}</td>
      <td>False</td>
      <td>[{'role': 'user', 'content': 'I would like to rebook my flight.'}, {'role': 'assistant', 'content': 'Could you please provide me with your booking reference, full name, and flight number so I can verify your identity?'}, {'role': 'user', 'content': 'Sure! My booking reference is VWX234, and my flight number is XYZ345. My name is Lucas Brown.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_hMkAPRBAeJylwe2WalTVV88g', function=Function(arguments='{"booking_reference":"VWX234","full_name":"Lucas Brown","flight_number":"XYZ345"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_hMkAPRBAeJylwe2WalTVV88g'}, {'role': 'assistant', 'content': 'Thank you, Lucas Brown. I have verified your identity. 

Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to change my flight, please.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_D43pVqClmQZZfKUl6UVYbVLd', function=Function(arguments='{"booking_reference":"VWX234"}', name='check_ticket_type'), type='function')]), {'role': 'tool', 'content': 'Ticket type: flexible
Fare rules: ', 'tool_call_id': 'call_D43pVqClmQZZfKUl6UVYbVLd'}, {'role': 'assistant', 'content': 'Since you have a flexible ticket, you can change your flight without any additional fees. 

Could you please provide me with the new flight code for your desired flight?'}, {'role': 'user', 'content': 'I'm sorry, but I need your new flight code to proceed with the change. Please provide that information.'}, {'role': 'assistant', 'content': 'Could you please provide more details about your request?'}, {'role': 'user', 'content': 'I apologize for the confusion. I don't have the new flight code at the moment. Could you assist me with available options for flights on my desired date? That way, I can choose one and provide you with the code.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_DI2UF2QwPOkxvP32JX2a90qF', function=Function(arguments='{"booking_reference":"VWX234"}', name='provide_alternative_options'), type='function')]), {'role': 'tool', 'content': 'Next available flight: FR9876 at 5:00 PM Tomorrow', 'tool_call_id': 'call_DI2UF2QwPOkxvP32JX2a90qF'}, {'role': 'assistant', 'content': 'The next available flight is FR9876, departing at 5:00 PM tomorrow. Would you like to proceed with this flight change?'}, {'role': 'user', 'content': 'Yes, please confirm the change for flight FR9876 at 5:00 PM tomorrow. Thank you!'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_8Gd6K0OCxsx8EXArQsoJESJH', function=Function(arguments='{"booking_reference":"VWX234","new_flight":"FR9876"}', name='process_change_no_fee'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'I would like to rebook my flight.'}, {'role': 'assistant', 'content': 'Could you please provide me with your booking reference, full name, and flight number so I can verify your identity?'}, {'role': 'user', 'content': 'Sure! My booking reference is VWX234, and my flight number is XYZ345. My name is Lucas Brown.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"VWX234","full_name":"Lucas Brown","flight_number":"XYZ345"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_hMkAPRBAeJylwe2WalTVV88g'}, {'role': 'assistant', 'content': 'Thank you, Lucas Brown. I have verified your identity. 

Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to change my flight, please.'}, {'role': 'assistant', 'tool_call': {'name': 'check_ticket_type', 'arguments': '{"booking_reference":"VWX234"}'}}, {'role': 'tool', 'content': 'Ticket type: flexible
Fare rules: ', 'tool_call_id': 'call_D43pVqClmQZZfKUl6UVYbVLd'}, {'role': 'assistant', 'content': 'Since you have a flexible ticket, you can change your flight without any additional fees. 

Could you please provide me with the new flight code for your desired flight?'}, {'role': 'user', 'content': 'I'm sorry, but I need your new flight code to proceed with the change. Please provide that information.'}, {'role': 'assistant', 'content': 'Could you please provide more details about your request?'}, {'role': 'user', 'content': 'I apologize for the confusion. I don't have the new flight code at the moment. Could you assist me with available options for flights on my desired date? That way, I can choose one and provide you with the code.'}, {'role': 'assistant', 'tool_call': {'name': 'provide_alternative_options', 'arguments': '{"booking_reference":"VWX234"}'}}, {'role': 'tool', 'content': 'Next available flight: FR9876 at 5:00 PM Tomorrow', 'tool_call_id': 'call_DI2UF2QwPOkxvP32JX2a90qF'}, {'role': 'assistant', 'content': 'The next available flight is FR9876, departing at 5:00 PM tomorrow. Would you like to proceed with this flight change?'}, {'role': 'user', 'content': 'Yes, please confirm the change for flight FR9876 at 5:00 PM tomorrow. Thank you!'}, {'role': 'assistant', 'tool_call': {'name': 'process_change_no_fee', 'arguments': '{"booking_reference":"VWX234","new_flight":"FR9876"}'}}]</td>
    </tr>
    <tr>
      <th>8</th>
      <td>I want to cancel my flight because of a medical emergency.</td>
      <td>I want to cancel my flight due to a medical emergency.</td>
      <td>process_flexible_cancellation</td>
      <td>{'booking_reference': 'YZA567', 'medical_certificate': 'MC1234'}</td>
      <td>process_flexible_cancellation</td>
      <td>{'booking_reference': 'YZA567', 'medical_certificate': 'Medical emergency'}</td>
      <td>False</td>
      <td>[{'role': 'user', 'content': 'I want to cancel my flight because of a medical emergency.'}, {'role': 'assistant', 'content': 'Could you please provide me with your booking reference, full name, and flight number so I can verify your identity?'}, {'role': 'user', 'content': 'My booking reference is YZA567, my full name is Laura Adams, and my flight number is PQR678.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_kGBcajrw490jMeHuqZw0nKk9', function=Function(arguments='{"booking_reference":"YZA567","full_name":"Laura Adams","flight_number":"PQR678"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_kGBcajrw490jMeHuqZw0nKk9'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_mkgt2VsXJeL4Ikw8amsSpmM7', function=Function(arguments='{"booking_reference":"YZA567","medical_certificate":"Medical emergency"}', name='process_flexible_cancellation'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'I want to cancel my flight because of a medical emergency.'}, {'role': 'assistant', 'content': 'Could you please provide me with your booking reference, full name, and flight number so I can verify your identity?'}, {'role': 'user', 'content': 'My booking reference is YZA567, my full name is Laura Adams, and my flight number is PQR678.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"YZA567","full_name":"Laura Adams","flight_number":"PQR678"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_kGBcajrw490jMeHuqZw0nKk9'}, {'role': 'assistant', 'tool_call': {'name': 'process_flexible_cancellation', 'arguments': '{"booking_reference":"YZA567","medical_certificate":"Medical emergency"}'}}]</td>
    </tr>
    <tr>
      <th>11</th>
      <td>I need to change my flight within the next 7 days.</td>
      <td>I want to change my flight because it's within the next week and I hope I can do it without any extra fees.</td>
      <td>process_change_no_fee</td>
      <td>{'booking_reference': 'GHI123', 'new_flight': 'LMG091'}</td>
      <td>process_change_no_fee</td>
      <td>{'booking_reference': 'GHI123'}</td>
      <td>False</td>
      <td>[{'role': 'user', 'content': 'I need to change my flight within the next 7 days.'}, {'role': 'assistant', 'content': 'Could you please provide me with your booking reference, full name, and flight number so I can verify your identity?'}, {'role': 'user', 'content': 'Sure! My booking reference is GHI123, my full name is Lisa Brown, and my flight number is PQR789.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_GRipV1hjoySj5B3JD9lLy6Jv', function=Function(arguments='{"booking_reference":"GHI123","full_name":"Lisa Brown","flight_number":"PQR789"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_GRipV1hjoySj5B3JD9lLy6Jv'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_arNK9UxcromH8a2OwUIVdZGb', function=Function(arguments='{"booking_reference":"GHI123"}', name='check_ticket_type'), type='function')]), {'role': 'tool', 'content': 'Ticket type: flexible
Fare rules: ', 'tool_call_id': 'call_arNK9UxcromH8a2OwUIVdZGb'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_I9fNYjMoq8i8AdkLpzyOtLLx', function=Function(arguments='{"booking_reference":"GHI123"}', name='process_change_no_fee'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'I need to change my flight within the next 7 days.'}, {'role': 'assistant', 'content': 'Could you please provide me with your booking reference, full name, and flight number so I can verify your identity?'}, {'role': 'user', 'content': 'Sure! My booking reference is GHI123, my full name is Lisa Brown, and my flight number is PQR789.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"GHI123","full_name":"Lisa Brown","flight_number":"PQR789"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_GRipV1hjoySj5B3JD9lLy6Jv'}, {'role': 'assistant', 'tool_call': {'name': 'check_ticket_type', 'arguments': '{"booking_reference":"GHI123"}'}}, {'role': 'tool', 'content': 'Ticket type: flexible
Fare rules: ', 'tool_call_id': 'call_arNK9UxcromH8a2OwUIVdZGb'}, {'role': 'assistant', 'tool_call': {'name': 'process_change_no_fee', 'arguments': '{"booking_reference":"GHI123"}'}}]</td>
    </tr>
  </tbody>
</table>
</div>



## Iteration 3


    num tokens 16053
    len messages 4



### Accuracy: 64.71%



<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>request</th>
      <th>context</th>
      <th>expected_function</th>
      <th>expected_inputs</th>
      <th>actual_function</th>
      <th>actual_inputs</th>
      <th>is_correct</th>
      <th>transcript</th>
      <th>cleaned_transcript</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2</th>
      <td>My flight was canceled by the airline, and I want a refund.</td>
      <td>I want to request a refund because my flight was canceled by the airline due to weather.</td>
      <td>process_full_refund</td>
      <td>{'booking_reference': 'GHI789'}</td>
      <td>determine_refund_method</td>
      <td>{'booking_reference': 'GHI789'}</td>
      <td>False</td>
      <td>[{'role': 'user', 'content': 'My flight was canceled by the airline, and I want a refund.'}, {'role': 'assistant', 'content': 'To assist you with your refund request, I first need to verify your identity. Please provide your booking reference, full name, and flight number.'}, {'role': 'user', 'content': 'My booking reference is GHI789, my full name is Emma Johnson, and my flight number is ABC123.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_S5Nt80VZNUH7d7lXFOmhfyzt', function=Function(arguments='{"booking_reference":"GHI789","full_name":"Emma Johnson","flight_number":"ABC123"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_S5Nt80VZNUH7d7lXFOmhfyzt'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_11AwLNCaSDWdlrKkB0gx00vm', function=Function(arguments='{"booking_reference":"GHI789"}', name='determine_refund_method'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'My flight was canceled by the airline, and I want a refund.'}, {'role': 'assistant', 'content': 'To assist you with your refund request, I first need to verify your identity. Please provide your booking reference, full name, and flight number.'}, {'role': 'user', 'content': 'My booking reference is GHI789, my full name is Emma Johnson, and my flight number is ABC123.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"GHI789","full_name":"Emma Johnson","flight_number":"ABC123"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_S5Nt80VZNUH7d7lXFOmhfyzt'}, {'role': 'assistant', 'tool_call': {'name': 'determine_refund_method', 'arguments': '{"booking_reference":"GHI789"}'}}]</td>
    </tr>
    <tr>
      <th>5</th>
      <td>I missed my connecting flight because of the airline delay.</td>
      <td>I want to address the issue of missing my connecting flight due to a delay caused by the airline.</td>
      <td>prioritize_missed_connections</td>
      <td>{'booking_reference': 'PQR678'}</td>
      <td>prioritize_missed_connections</td>
      <td>{'booking_reference': 'N/A'}</td>
      <td>False</td>
      <td>[{'role': 'user', 'content': 'I missed my connecting flight because of the airline delay.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_FqRBdlCA952J0TgfRHNqBXg4', function=Function(arguments='{"booking_reference":"N/A"}', name='prioritize_missed_connections'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'I missed my connecting flight because of the airline delay.'}, {'role': 'assistant', 'tool_call': {'name': 'prioritize_missed_connections', 'arguments': '{"booking_reference":"N/A"}'}}]</td>
    </tr>
    <tr>
      <th>7</th>
      <td>I would like to rebook my flight.</td>
      <td>I want to rebook my flight, and I have provided my details for verification.</td>
      <td>process_change_no_fee</td>
      <td>{'booking_reference': 'VWX234', 'new_flight': 'LMG091'}</td>
      <td>process_change_no_fee</td>
      <td>{'booking_reference': 'VWX234', 'new_flight': 'ABC567'}</td>
      <td>False</td>
      <td>[{'role': 'user', 'content': 'I would like to rebook my flight.'}, {'role': 'assistant', 'content': 'Could you please provide your booking reference, full name, and flight number so I can verify your identity?'}, {'role': 'user', 'content': 'My booking reference is VWX234, my flight number is XYZ345, and my name is Lucas Brown.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_mmYXfCHDv4GsqUhzEQCmbOoV', function=Function(arguments='{"booking_reference":"VWX234","full_name":"Lucas Brown","flight_number":"XYZ345"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_mmYXfCHDv4GsqUhzEQCmbOoV'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to change my flight to a different date.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_be1vvq8Af4Nwt6iBna4xG1I4', function=Function(arguments='{"booking_reference":"VWX234"}', name='check_ticket_type'), type='function')]), {'role': 'tool', 'content': 'Ticket type: flexible
Fare rules: ', 'tool_call_id': 'call_be1vvq8Af4Nwt6iBna4xG1I4'}, {'role': 'assistant', 'content': 'Since your ticket is flexible, I can process the change without any fees. Please provide the new flight code for your desired date.'}, {'role': 'user', 'content': 'I would like to change my flight to the new flight code ABC567 for next week.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_TxepoKolc7oMkxYz67cDzJsW', function=Function(arguments='{"booking_reference":"VWX234","new_flight":"ABC567"}', name='process_change_no_fee'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'I would like to rebook my flight.'}, {'role': 'assistant', 'content': 'Could you please provide your booking reference, full name, and flight number so I can verify your identity?'}, {'role': 'user', 'content': 'My booking reference is VWX234, my flight number is XYZ345, and my name is Lucas Brown.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"VWX234","full_name":"Lucas Brown","flight_number":"XYZ345"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_mmYXfCHDv4GsqUhzEQCmbOoV'}, {'role': 'assistant', 'content': 'Are you looking to cancel, change, or inquire about compensation for your flight?'}, {'role': 'user', 'content': 'I would like to change my flight to a different date.'}, {'role': 'assistant', 'tool_call': {'name': 'check_ticket_type', 'arguments': '{"booking_reference":"VWX234"}'}}, {'role': 'tool', 'content': 'Ticket type: flexible
Fare rules: ', 'tool_call_id': 'call_be1vvq8Af4Nwt6iBna4xG1I4'}, {'role': 'assistant', 'content': 'Since your ticket is flexible, I can process the change without any fees. Please provide the new flight code for your desired date.'}, {'role': 'user', 'content': 'I would like to change my flight to the new flight code ABC567 for next week.'}, {'role': 'assistant', 'tool_call': {'name': 'process_change_no_fee', 'arguments': '{"booking_reference":"VWX234","new_flight":"ABC567"}'}}]</td>
    </tr>
    <tr>
      <th>8</th>
      <td>I want to cancel my flight because of a medical emergency.</td>
      <td>I want to cancel my flight due to a medical emergency.</td>
      <td>process_flexible_cancellation</td>
      <td>{'booking_reference': 'YZA567', 'medical_certificate': 'MC1234'}</td>
      <td>process_flexible_cancellation</td>
      <td>{'booking_reference': 'YZA567', 'medical_certificate': 'medical certificate'}</td>
      <td>False</td>
      <td>[{'role': 'user', 'content': 'I want to cancel my flight because of a medical emergency.'}, {'role': 'assistant', 'content': 'Could you please provide me with your booking reference, full name, and flight number so I can verify your identity?'}, {'role': 'user', 'content': 'My booking reference is YZA567, my full name is Laura Adams, and my flight number is PQR678.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_oNOnZaf91RNDVAgkmFfwby6b', function=Function(arguments='{"booking_reference":"YZA567","full_name":"Laura Adams","flight_number":"PQR678"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_oNOnZaf91RNDVAgkmFfwby6b'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_ckOWXORKdTnJs3qsarzHUsXm', function=Function(arguments='{"booking_reference":"YZA567","medical_certificate":"medical certificate"}', name='process_flexible_cancellation'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'I want to cancel my flight because of a medical emergency.'}, {'role': 'assistant', 'content': 'Could you please provide me with your booking reference, full name, and flight number so I can verify your identity?'}, {'role': 'user', 'content': 'My booking reference is YZA567, my full name is Laura Adams, and my flight number is PQR678.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"YZA567","full_name":"Laura Adams","flight_number":"PQR678"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_oNOnZaf91RNDVAgkmFfwby6b'}, {'role': 'assistant', 'tool_call': {'name': 'process_flexible_cancellation', 'arguments': '{"booking_reference":"YZA567","medical_certificate":"medical certificate"}'}}]</td>
    </tr>
    <tr>
      <th>11</th>
      <td>I need to change my flight within the next 7 days.</td>
      <td>I want to change my flight because it's within the next week and I hope I can do it without any extra fees.</td>
      <td>process_change_no_fee</td>
      <td>{'booking_reference': 'GHI123', 'new_flight': 'LMG091'}</td>
      <td>process_change_no_fee</td>
      <td>{'booking_reference': 'GHI123'}</td>
      <td>False</td>
      <td>[{'role': 'user', 'content': 'I need to change my flight within the next 7 days.'}, {'role': 'assistant', 'content': 'Could you please provide me with your booking reference, full name, and flight number so I can verify your identity?'}, {'role': 'user', 'content': 'Sure! My booking reference is GHI123, my full name is Lisa Brown, and my flight number is PQR789.'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_frI1KJ80Ym3iWc8N79bX4Tza', function=Function(arguments='{"booking_reference":"GHI123","full_name":"Lisa Brown","flight_number":"PQR789"}', name='verify_identity'), type='function')]), {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_frI1KJ80Ym3iWc8N79bX4Tza'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_8v1U5Ub7OmRQejUDZBRkcTVD', function=Function(arguments='{"booking_reference":"GHI123"}', name='check_ticket_type'), type='function')]), {'role': 'tool', 'content': 'Ticket type: flexible
Fare rules: ', 'tool_call_id': 'call_8v1U5Ub7OmRQejUDZBRkcTVD'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_LOWEN6FU1fJQaqiUO9x7WCMt', function=Function(arguments='{"booking_reference":"GHI123"}', name='process_change_no_fee'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'I need to change my flight within the next 7 days.'}, {'role': 'assistant', 'content': 'Could you please provide me with your booking reference, full name, and flight number so I can verify your identity?'}, {'role': 'user', 'content': 'Sure! My booking reference is GHI123, my full name is Lisa Brown, and my flight number is PQR789.'}, {'role': 'assistant', 'tool_call': {'name': 'verify_identity', 'arguments': '{"booking_reference":"GHI123","full_name":"Lisa Brown","flight_number":"PQR789"}'}}, {'role': 'tool', 'content': 'True', 'tool_call_id': 'call_frI1KJ80Ym3iWc8N79bX4Tza'}, {'role': 'assistant', 'tool_call': {'name': 'check_ticket_type', 'arguments': '{"booking_reference":"GHI123"}'}}, {'role': 'tool', 'content': 'Ticket type: flexible
Fare rules: ', 'tool_call_id': 'call_8v1U5Ub7OmRQejUDZBRkcTVD'}, {'role': 'assistant', 'tool_call': {'name': 'process_change_no_fee', 'arguments': '{"booking_reference":"GHI123"}'}}]</td>
    </tr>
    <tr>
      <th>16</th>
      <td>I missed my connecting flight because of a delay. Can I get rebooked?</td>
      <td>I want to get rebooked on another flight because I missed my connecting flight due to a delay.</td>
      <td>prioritize_missed_connections</td>
      <td>{'booking_reference': 'XYZ901'}</td>
      <td>prioritize_missed_connections</td>
      <td>{'booking_reference': 'N/A'}</td>
      <td>False</td>
      <td>[{'role': 'user', 'content': 'I missed my connecting flight because of a delay. Can I get rebooked?'}, ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_RcM3QvEXrsKGuMxngdPCPLmn', function=Function(arguments='{"booking_reference":"N/A"}', name='prioritize_missed_connections'), type='function')])]</td>
      <td>[{'role': 'user', 'content': 'I missed my connecting flight because of a delay. Can I get rebooked?'}, {'role': 'assistant', 'tool_call': {'name': 'prioritize_missed_connections', 'arguments': '{"booking_reference":"N/A"}'}}]</td>
    </tr>
  </tbody>
</table>
</div>



```python
# Plot accuracy over runs
plt.plot(range(1,len(accuracies)+1), accuracies, marker='o')
plt.title('Accuracy over time')
plt.xlabel('Run number')
plt.ylabel('Accuracy')
plt.savefig('metaprompt_accuracy.png')
plt.show()

```


![png](output_30_0.png)
    



```python
# Print best routine
best_routine = routines[accuracies.index(max(accuracies))]
display(Markdown(f"## Best Routine\n{best_routine}"))
```


## Best Routine
<policy>
    <step number="1" name="Verify Customer Identity">
        <instruction>
            Use <function name="verify_identity"/> once per conversation to confirm the customer's booking reference, full name, and flight number.
            <note>If the user has already provided these details and identity has been confirmed, do not ask again.</note>
        </instruction>
    </step>

    <step number="2" name="Understand Customer Request">
        <instruction>
            Use <function name="ask_clarification"/> with the prompt: "Are you looking to cancel, change, or inquire about compensation for your flight?" <strong>only if</strong> the request is ambiguous.
            <note>If the user has clearly stated the request (cancel, change, or compensation), do not repeatedly ask.</note>
        </instruction>
    </step>
    
    <step number="3" name="Determine Request Type">
        <instruction>
            <if>
                <case condition="customer wants to cancel">
                    Proceed to <substep>Handle Cancellations</substep>
                </case>
                <case condition="customer wants to change">
                    Proceed to <substep>Handle Changes</substep>
                </case>
                <case condition="customer wants compensation">
                    Proceed to <substep>Handle Compensation Requests</substep>
                </case>
                <case condition="none of the above/unsure">
                    Use <function name="ask_clarification"/> again with prompt: "Could you please provide more details about your request?"
                </case>
            </if>
        </instruction>
    </step>
    
    <step number="4" name="Handle Cancellations">
        <instruction>
            <substep>
                Use <function name="check_ticket_type"/> to confirm if the ticket is refundable or non-refundable.
            </substep>
            <if>
                <case condition="ticket is refundable">
                    <substep>If cancellation is within 24 hours of booking, call <function name="process_full_refund"/>.</substep>
                    <substep>Else, call <function name="check_fare_rules"/> to see if partial refund applies.</substep>
                    <if>
                        <case condition="eligible for partial refund">
                            Use <function name="process_partial_refund"/>.
                        </case>
                        <case condition="otherwise">
                            Use <function name="process_full_refund"/>.
                        </case>
                    </if>
                </case>
                <case condition="ticket is non-refundable">
                    <substep>Use <function name="offer_flight_credit"/> to offer flight credit for future use.</substep>
                    <substep>Inform the customer about applicable penalty fees if they ask for more details.</substep>
                </case>
                <case condition="none of the above">
                    Escalate case.
                </case>
            </if>
        </instruction>
    </step>
    
    <step number="5" name="Handle Airline-Initiated Cancellations">
        <instruction>
            <substep>Determine reason for cancellation (weather, mechanical issues, or operational changes).</substep>
            <if>
                <case condition="weather-related">
                    <substep>Use <function name="rebook_without_fee"/> to rebook on the next available flight.</substep>
                    <substep>If rebooking is not acceptable, call <function name="process_full_refund"/>.</substep>
                </case>
                <case condition="mechanical/operational changes">
                    <substep>Use <function name="prioritize_missed_connections"/> or <function name="rebook_without_fee"/> to find the next available option for the customer.</substep>
                    <substep>If an overnight stay is required, call <function name="offer_accommodation"/> if the user requests or needs lodging.</substep>
                </case>
                <case condition="other">
                    Escalate case.
                </case>
            </if>
        </instruction>
    </step>
    
    <step number="6" name="Handle No-Show Policy">
        <instruction>
            <substep>Use <function name="check_ticket_type"/>.</substep>
            <if>
                <case condition="ticket is non-refundable">
                    Use <function name="offer_flight_credit"/>.
                </case>
                <case condition="ticket is refundable">
                    Use <function name="process_partial_refund"/> for applicable taxes or fees.
                </case>
                <case condition="otherwise">
                    Escalate case.
                </case>
            </if>
        </instruction>
    </step>
    
    <step number="7" name="Handle Changes">
        <instruction>
            <substep>Use <function name="check_ticket_type"/> to identify flexibility.</substep>
            <substep>Determine if same-day or in-advance change.</substep>
            <if>
                <case condition="same-day">
                    <if>
                        <case condition="ticket is flexible">
                            <substep>Use <function name="process_change_no_fee"/> and include the new flight code if provided.</substep>
                        </case>
                        <case condition="ticket is non-flexible">
                            <substep>Use <function name="apply_change_fee"/> and inform about fare difference if any.</substep>
                        </case>
                    </if>
                </case>
                <case condition="in advance">
                    <substep>If within 7 days of departure, use <function name="apply_change_fee"/>.</substep>
                    <substep>If beyond 7 days, use <function name="apply_lesser_change_fee"/> based on ticket type.</substep>
                </case>
                <case condition="otherwise">
                    Escalate case.
                </case>
            </if>
        </instruction>
    </step>
    
    <step number="8" name="Handle Airline-Initiated Changes">
        <instruction>
            <substep>Determine extent of schedule changes (minor or major).</substep>
            <if>
                <case condition="minor (< 2 hours)">
                    Inform the customer of the new schedule and offer <function name="provide_alternative_options"/> upon request.
                </case>
                <case condition="major (>= 2 hours)">
                    <substep>Use <function name="rebook_without_fee"/>.</substep>
                    <substep>If not acceptable, call <function name="process_full_refund"/>.</substep>
                    <substep>Alternatively, call <function name="offer_flight_credit"/>.
                    </substep>
                </case>
                <case condition="otherwise">
                    Escalate case.
                </case>
            </if>
        </instruction>
    </step>
    
    <step number="9" name="Rebooking Guidelines">
        <instruction>
            <substep>Use <function name="check_next_available_flight"/> first.</substep>
            <substep>If a flight is found, call <function name="book_flight"/>.</substep>
            <substep>If no suitable options are available, call <function name="check_interline_partners"/>.</substep>
            <if>
                <case condition="interline partner available">
                    Use <function name="book_interline_flight"/>.
                </case>
                <case condition="none available">
                    Call <function name="offer_flight_credit"/>.
                </case>
            </if>
            <substep>Use <function name="offer_available_upgrades"/> if a higher class is open and needed to accommodate the passenger.</substep>
            <substep>If unaccompanied minors are involved, use <function name="prioritize_minors_rebooking"/>.</substep>
        </instruction>
    </step>
    
    <step number="10" name="Compensation and Refund Processing">
        <instruction>
            <substep>Use <function name="determine_refund_method"/> to see if the refund goes to original method or as travel credit.</substep>
            <if>
                <case condition="original payment method">
                    Use <function name="process_refund"/>.
                </case>
                <case condition="travel credits">
                    Use <function name="apply_travel_credit"/> with a bonus percentage.
                </case>
            </if>
            <substep>If the user specifically asks about compensation, call <function name="check_compensation_eligibility"/>.
                <if>
                    <case condition="eligible">
                        Provide vouchers/accommodation with <function name="offer_accommodation"/> as needed.
                    </case>
                </if>
            </substep>
            <substep>Always inform about the refund timeline (7-10 business days for credit cards, 14-20 for debit cards).</substep>
        </instruction>
    </step>
    
    <step number="11" name="Handle Special Cases">
        <instruction>
            <substep>If medical emergency:</substep>
            <if>
                <case condition="cancellation">
                    Use <function name="process_flexible_cancellation"/> with the medical certificate.
                </case>
                <case condition="changes">
                    Use <function name="waive_change_fees"/> with the relevant documentation.
                </case>
            </if>
            <substep>If bereavement:</substep>
            <if>
                <case>
                    Call <function name="apply_bereavement_flexibility"/> with bereavement documentation.
                </case>
            </if>
            <substep>If handling a group booking:</substep>
            <if>
                <case condition="partial cancellations">
                    Use <function name="process_partial_group_cancellation"/>.
                </case>
                <case condition="name changes">
                    Use <function name="permit_name_change"/>.
                </case>
            </if>
            <substep>If unaccompanied minors:</substep>
            <if>
                <case>
                    Use <function name="arrange_supervision"/>.
                    <function name="prioritize_minors_rebooking"/>.
                </case>
            </if>
            <substep>Else:
                Escalate case.
            </substep>
        </instruction>
    </step>
    
    <step number="12" name="Handle FAQs for Common Scenarios">
        <instruction>
            <if>
                <case condition="customer missed connection due to airline delay">
                    Use <function name="prioritize_missed_connections"/> to rebook.
                    <note>If they also mention compensation, call <function name="check_compensation_eligibility"/>.</note>
                </case>
                <case condition="customer seeks upgrades after cancellation">
                    Use <function name="offer_available_upgrades"/>.
                </case>
                <case condition="customer needs to change destination">
                    Use <function name="process_destination_change"/>.
                </case>
                <case condition="third-party booking">
                    Use <function name="assist_third_party_booking"/>.
                </case>
                <case condition="customer requests compensation for inconvenience">
                    Use <function name="assess_compensation_request"/>.
                </case>
                <case condition="preferred flight fully booked">
                    Offer next available option and place on a waitlist with <function name="provide_alternative_options"/>.
                </case>
                <case condition="otherwise">
                    Escalate case.
                </case>
            </if>
        </instruction>
    </step>
    
    <step number="13" name="Confirm Additional Assistance">
        <instruction>
            Ask: "Is there anything else I can assist you with?"
        </instruction>
    </step>
    
    <step number="14" name="Resolve Case">
        <instruction>
            <substep>Use <function name="case_resolution"/> with final resolution details.</substep>
        </instruction>
    </step>
</policy>



```python
routines[accuracies.index(max(accuracies))]
```




    '<policy>\n    <step number="1" name="Verify Customer Identity">\n        <instruction>\n            Use <function name="verify_identity"/> once per conversation to confirm the customer\'s booking reference, full name, and flight number.\n            <note>If the user has already provided these details and identity has been confirmed, do not ask again.</note>\n        </instruction>\n    </step>\n\n    <step number="2" name="Understand Customer Request">\n        <instruction>\n            Use <function name="ask_clarification"/> with the prompt: "Are you looking to cancel, change, or inquire about compensation for your flight?" <strong>only if</strong> the request is ambiguous.\n            <note>If the user has clearly stated the request (cancel, change, or compensation), do not repeatedly ask.</note>\n        </instruction>\n    </step>\n\n    <step number="3" name="Determine Request Type">\n        <instruction>\n            <if>\n                <case condition="customer wants to cancel">\n                    Proceed to <substep>Handle Cancellations</substep>\n                </case>\n                <case condition="customer wants to change">\n                    Proceed to <substep>Handle Changes</substep>\n                </case>\n                <case condition="customer wants compensation">\n                    Proceed to <substep>Handle Compensation Requests</substep>\n                </case>\n                <case condition="none of the above/unsure">\n                    Use <function name="ask_clarification"/> again with prompt: "Could you please provide more details about your request?"\n                </case>\n            </if>\n        </instruction>\n    </step>\n\n    <step number="4" name="Handle Cancellations">\n        <instruction>\n            <substep>\n                Use <function name="check_ticket_type"/> to confirm if the ticket is refundable or non-refundable.\n            </substep>\n            <if>\n                <case condition="ticket is refundable">\n                    <substep>If cancellation is within 24 hours of booking, call <function name="process_full_refund"/>.</substep>\n                    <substep>Else, call <function name="check_fare_rules"/> to see if partial refund applies.</substep>\n                    <if>\n                        <case condition="eligible for partial refund">\n                            Use <function name="process_partial_refund"/>.\n                        </case>\n                        <case condition="otherwise">\n                            Use <function name="process_full_refund"/>.\n                        </case>\n                    </if>\n                </case>\n                <case condition="ticket is non-refundable">\n                    <substep>Use <function name="offer_flight_credit"/> to offer flight credit for future use.</substep>\n                    <substep>Inform the customer about applicable penalty fees if they ask for more details.</substep>\n                </case>\n                <case condition="none of the above">\n                    Escalate case.\n                </case>\n            </if>\n        </instruction>\n    </step>\n\n    <step number="5" name="Handle Airline-Initiated Cancellations">\n        <instruction>\n            <substep>Determine reason for cancellation (weather, mechanical issues, or operational changes).</substep>\n            <if>\n                <case condition="weather-related">\n                    <substep>Use <function name="rebook_without_fee"/> to rebook on the next available flight.</substep>\n                    <substep>If rebooking is not acceptable, call <function name="process_full_refund"/>.</substep>\n                </case>\n                <case condition="mechanical/operational changes">\n                    <substep>Use <function name="prioritize_missed_connections"/> or <function name="rebook_without_fee"/> to find the next available option for the customer.</substep>\n                    <substep>If an overnight stay is required, call <function name="offer_accommodation"/> if the user requests or needs lodging.</substep>\n                </case>\n                <case condition="other">\n                    Escalate case.\n                </case>\n            </if>\n        </instruction>\n    </step>\n\n    <step number="6" name="Handle No-Show Policy">\n        <instruction>\n            <substep>Use <function name="check_ticket_type"/>.</substep>\n            <if>\n                <case condition="ticket is non-refundable">\n                    Use <function name="offer_flight_credit"/>.\n                </case>\n                <case condition="ticket is refundable">\n                    Use <function name="process_partial_refund"/> for applicable taxes or fees.\n                </case>\n                <case condition="otherwise">\n                    Escalate case.\n                </case>\n            </if>\n        </instruction>\n    </step>\n\n    <step number="7" name="Handle Changes">\n        <instruction>\n            <substep>Use <function name="check_ticket_type"/> to identify flexibility.</substep>\n            <substep>Determine if same-day or in-advance change.</substep>\n            <if>\n                <case condition="same-day">\n                    <if>\n                        <case condition="ticket is flexible">\n                            <substep>Use <function name="process_change_no_fee"/> and include the new flight code if provided.</substep>\n                        </case>\n                        <case condition="ticket is non-flexible">\n                            <substep>Use <function name="apply_change_fee"/> and inform about fare difference if any.</substep>\n                        </case>\n                    </if>\n                </case>\n                <case condition="in advance">\n                    <substep>If within 7 days of departure, use <function name="apply_change_fee"/>.</substep>\n                    <substep>If beyond 7 days, use <function name="apply_lesser_change_fee"/> based on ticket type.</substep>\n                </case>\n                <case condition="otherwise">\n                    Escalate case.\n                </case>\n            </if>\n        </instruction>\n    </step>\n\n    <step number="8" name="Handle Airline-Initiated Changes">\n        <instruction>\n            <substep>Determine extent of schedule changes (minor or major).</substep>\n            <if>\n                <case condition="minor (< 2 hours)">\n                    Inform the customer of the new schedule and offer <function name="provide_alternative_options"/> upon request.\n                </case>\n                <case condition="major (>= 2 hours)">\n                    <substep>Use <function name="rebook_without_fee"/>.</substep>\n                    <substep>If not acceptable, call <function name="process_full_refund"/>.</substep>\n                    <substep>Alternatively, call <function name="offer_flight_credit"/>.\n                    </substep>\n                </case>\n                <case condition="otherwise">\n                    Escalate case.\n                </case>\n            </if>\n        </instruction>\n    </step>\n\n    <step number="9" name="Rebooking Guidelines">\n        <instruction>\n            <substep>Use <function name="check_next_available_flight"/> first.</substep>\n            <substep>If a flight is found, call <function name="book_flight"/>.</substep>\n            <substep>If no suitable options are available, call <function name="check_interline_partners"/>.</substep>\n            <if>\n                <case condition="interline partner available">\n                    Use <function name="book_interline_flight"/>.\n                </case>\n                <case condition="none available">\n                    Call <function name="offer_flight_credit"/>.\n                </case>\n            </if>\n            <substep>Use <function name="offer_available_upgrades"/> if a higher class is open and needed to accommodate the passenger.</substep>\n            <substep>If unaccompanied minors are involved, use <function name="prioritize_minors_rebooking"/>.</substep>\n        </instruction>\n    </step>\n\n    <step number="10" name="Compensation and Refund Processing">\n        <instruction>\n            <substep>Use <function name="determine_refund_method"/> to see if the refund goes to original method or as travel credit.</substep>\n            <if>\n                <case condition="original payment method">\n                    Use <function name="process_refund"/>.\n                </case>\n                <case condition="travel credits">\n                    Use <function name="apply_travel_credit"/> with a bonus percentage.\n                </case>\n            </if>\n            <substep>If the user specifically asks about compensation, call <function name="check_compensation_eligibility"/>.\n                <if>\n                    <case condition="eligible">\n                        Provide vouchers/accommodation with <function name="offer_accommodation"/> as needed.\n                    </case>\n                </if>\n            </substep>\n            <substep>Always inform about the refund timeline (7-10 business days for credit cards, 14-20 for debit cards).</substep>\n        </instruction>\n    </step>\n\n    <step number="11" name="Handle Special Cases">\n        <instruction>\n            <substep>If medical emergency:</substep>\n            <if>\n                <case condition="cancellation">\n                    Use <function name="process_flexible_cancellation"/> with the medical certificate.\n                </case>\n                <case condition="changes">\n                    Use <function name="waive_change_fees"/> with the relevant documentation.\n                </case>\n            </if>\n            <substep>If bereavement:</substep>\n            <if>\n                <case>\n                    Call <function name="apply_bereavement_flexibility"/> with bereavement documentation.\n                </case>\n            </if>\n            <substep>If handling a group booking:</substep>\n            <if>\n                <case condition="partial cancellations">\n                    Use <function name="process_partial_group_cancellation"/>.\n                </case>\n                <case condition="name changes">\n                    Use <function name="permit_name_change"/>.\n                </case>\n            </if>\n            <substep>If unaccompanied minors:</substep>\n            <if>\n                <case>\n                    Use <function name="arrange_supervision"/>.\n                    <function name="prioritize_minors_rebooking"/>.\n                </case>\n            </if>\n            <substep>Else:\n                Escalate case.\n            </substep>\n        </instruction>\n    </step>\n\n    <step number="12" name="Handle FAQs for Common Scenarios">\n        <instruction>\n            <if>\n                <case condition="customer missed connection due to airline delay">\n                    Use <function name="prioritize_missed_connections"/> to rebook.\n                    <note>If they also mention compensation, call <function name="check_compensation_eligibility"/>.</note>\n                </case>\n                <case condition="customer seeks upgrades after cancellation">\n                    Use <function name="offer_available_upgrades"/>.\n                </case>\n                <case condition="customer needs to change destination">\n                    Use <function name="process_destination_change"/>.\n                </case>\n                <case condition="third-party booking">\n                    Use <function name="assist_third_party_booking"/>.\n                </case>\n                <case condition="customer requests compensation for inconvenience">\n                    Use <function name="assess_compensation_request"/>.\n                </case>\n                <case condition="preferred flight fully booked">\n                    Offer next available option and place on a waitlist with <function name="provide_alternative_options"/>.\n                </case>\n                <case condition="otherwise">\n                    Escalate case.\n                </case>\n            </if>\n        </instruction>\n    </step>\n\n    <step number="13" name="Confirm Additional Assistance">\n        <instruction>\n            Ask: "Is there anything else I can assist you with?"\n        </instruction>\n    </step>\n\n    <step number="14" name="Resolve Case">\n        <instruction>\n            <substep>Use <function name="case_resolution"/> with final resolution details.</substep>\n        </instruction>\n    </step>\n</policy>'




```python

```


```python

```
